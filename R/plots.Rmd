# Setup

```{r setup}
library(magrittr)
library(ggplot2)
library(ggrepel)
library(GenomicRanges)

library(org.Dm.eg.db)
library(AnnotationDbi)

library(EnrichedHeatmap)
library(ComplexHeatmap)

library(GO.db)

library(patchwork)

source('utils.R')
source('~/NystLib/R/peakUtils.R') #TODO move/rewrite getPeakData from NystLib to utils.R
```

## load data
```{r setup}

load('rData/sheets.rda')
load('rData/peaks.rda')

#TODO move RNAseq data into BAP project
# TODO this is in progress - mixed across directories
load('rData/wing-rnaseq-GeTMM.RData')  # GeTMM normalized RNAseq
#loads 'wing.rnaseq'

#load('rData/wing-rnaseq-DDS.RData')  # loads dds.results 
## TODO -- no id validation yet need to fix
#rna.dds <- dds.results %>%
#  dplyr::filter(baseMean_6h > 0) %>%
#  tibble::rownames_to_column(var = 'Geneid')

ON.genes <- wing.rnaseq %>%
  dplyr::filter(mean >= 2) %>%
  dplyr::select(Geneid) 

ON.genes %>% write.table('on-rnaseq.txt', sep = '\n', row.names = F, col.names = F, quote = F)
#TODO clean this up - had to write out the on list and use the flybase id validator tool... 
ON.genes.validated <- read.table('~/McKay/Wing-RNAseq/on-genes-IDvalidation.txt', header = T) %>%
  dplyr::rename(Geneid = submitted_item, 
                Validated = validated_id,
                Symbol = current_symbol)

#TODO move flyfactor database to BAP - code to download to repo?
## load in a flyfacotr fbgn validated .txt - generated with Flybase id validator

## there are 2 'FlyFactor' FBgn codes that are updated two more than 1 unique 'Validated' FBgns in `fbgn.validated`
# FBgn0051782 -- CG31782 in flyfactor - old annotation? no present in Flybase, maybe split into three differen pseudogene annos now
# FBgn0050420 -- is only Atf-2 in flyfactor db
fbgn.validated <- read.table('~/McKay/Motif_databases/FLY/fbgn_validated.txt', header = F, sep = '\t')
colnames(fbgn.validated) <- c('FlyFactor', 'Validated', 'Symbol')
fbgn.validated %<>% 
  dplyr::filter(FlyFactor != 'FBgn0051782') %>% #drop this FBgn, problematic update to multiple new FBgns of pseudogenes
  dplyr::filter(Validated != 'FBgn0265182') # drop this Validated FBgn, which is an incorrectly updated from FBgn0050420
```

## global variables
```{r setup}
###
# assign global variables
###

dm6 <- BSgenome.Dmelanogaster.UCSC.dm6::BSgenome.Dmelanogaster.UCSC.dm6
dm3 <- BSgenome.Dmelanogaster.UCSC.dm3::BSgenome.Dmelanogaster.UCSC.dm3
dm6.TxDb <- TxDb.Dmelanogaster.UCSC.dm6.ensGene::TxDb.Dmelanogaster.UCSC.dm6.ensGene

dm6.promoters <- ChIPseeker::getPromoters(dm6.TxDb, upstream = 500, downstream = 100) 
dm6.genes <- GenomicFeatures::genes(dm6.TxDb)

brD <- data.frame('seqnames' = 'chrX',
                  'start' = 1565708,
                  'end' = 1567401) %>%
  GenomicRanges::GRanges()

shn <- data.frame('seqnames' = 'chr2R',
                  'start' = 11159086,
                  'end' = 11217394) %>% 
  GRanges()

sbb <- data.frame('seqnames' = 'chr2R',
                  'start' = 18278198,
                  'end' = 18357296) %>%
  GRanges()

# Dl 
#chr3R:19,265,389-19,350,508
Dl <- data.frame('seqnames' = 'chr3R',
                  'start' = 19265389,
                  'end' = 19350508) %>%
  GRanges()


# E(spl)-c
#chr3R:25,980,255-26,065,374
espl <- data.frame('seqnames' = 'chr3R',
                  'start' = 25980255,
                  'end' = 26065374) %>%
  GRanges()
```

## memes setup
```{r setup}
### 
# meme db 
###
#TODO - so clunky...
# loading in the fly factor database, drop out a couple of problematic fbgn
# then use the fbgn.validated lookup table for fly factor to update all the old ids to correct ids
# then filter on the on gene list -- which has to go through a similar process of id validation
# gross
meme_db <- universalmotif::read_meme('~/McKay/Motif_databases/FLY/fly_factor_survey.meme') %>%
  universalmotif::to_df() %>%
  dplyr::group_by(name) %>%
  dplyr::filter(!grepl('FBgn0051782|FBgn0265182', name)) %>%  #drop this FBgn, problematic update to multiple new FBgns of pseudogenes
  dplyr::mutate(basename = stringr::str_split_fixed(name, '_', n = 2)[[1]],
                fbgn.validated = fbgn.validated[fbgn.validated$FlyFactor == basename,]$Validated) 

meme_db_on <- meme_db %>%
  dplyr::filter(fbgn.validated %in% ON.genes.validated$Validated)

options(meme_db = universalmotif::to_list(meme_db_on, extrainfo = F))

```

## colors
```{r setup}
viridis.hex <- c("#440154","#3b528b","#21918c","#5ec962","#5ec962","#fde725")
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cbPalette.4 <- c("#D81B60","#1E88E5","#FFC107","#004D40")
cbPalette.ibm <- c('#332288','#117733','#44AA99','#88CCEE','#DDCC77','#CC6677','#AA4499','#882255')

## browser 
WTFAIRE.colors <- c("grey10","grey20","grey30","grey40","grey50","grey60")
```

## peak subsets
```{r setup}
osaPeaks <- peaks$cnr.df %>% 
  dplyr::filter(osa.cnr & !yw.cnr) %>% 
  GRanges() %>% 
  resize(width = 1, fix = "center")

osaPeaks.full <- peaks$cnr.df %>% 
  dplyr::filter(osa.cnr & !yw.cnr) %>% 
  GRanges()

fairePeaks.wt <- peaks$faire.wt.df %>%
#  dplyr::filter(assay == 'faire' & experiment == 'WT FAIRE Wing Timecourse') %>%
  GRanges() %>%
  resize(width = 1, fix = "center")

#redundant... but used in a couple chunks for motif analysis
fairePeaks.wt.full <- peaks$faire.wt.df %>% 
  dplyr::filter(assay == 'faire'  & experiment == 'WT FAIRE Wing Timecourse')


#DONE - remove the peakCat ? since now using log2fold change for these categories...
fairePeaks.deg <- peaks$faire.osaDeg.df %>%
#  dplyr::filter(assay == 'faire' & experiment == 'osaGFP deGrad Pupal Wing FAIRE') %>%
  dplyr::filter(osaGFP.deGrad | osaGFP.control) %>% # want to only use peaks that are reproducible and of good quality 
  GRanges() %>%
  resize(width = 1, fix = "center")

#fairePeaks.osaDependent <- fairePeaks.deg %>% 
#  data.frame() %>% 
#  dplyr::filter(faireCat.osaDeGrad == 'Osa Dependent') %>%
#  GRanges()
#
#fairePeaks.osaIndependent <- fairePeaks.deg %>%
#  data.frame() %>%
#  dplyr::filter(faireCat.osaDeGrad == 'Osa Independent') %>%
#  GRanges()
#
#fairePeaks.osaEctopic <- fairePeaks.deg %>%
#  data.frame() %>%
#  dplyr::filter(faireCat.osaDeGrad == 'Osa Ectopic') %>%
#  GRanges()
```



## load bws 

```{r setup}

#TODO - cleanup - move matrices?

bws <- get_bws(dplyr::bind_rows(cnr.ss, faire.wt.ssPool), 'id') 

deg.bws <- get_bws(faire.ss %>% dplyr::filter(experiment == 'osaGFP deGrad FAIRE'), 'id')

```

## functions 

```{r setup}
plot.frac <- function(x) {
 lapply(unique(x$change), function(i) {
   x %>%
     dplyr::filter(change == i) %>%
     ggplot(aes(fraction, change, fill = Osa.Bound)) +
     geom_bar(stat = 'identity', width = 1) +
     geom_text(aes(label = per), position = position_fill(vjust = 0.6),  size = 7, fontface = "bold") +
     #geom_text(aes(label = per, position = position_stack(vjust = 0.5))) +
     scale_fill_manual(values = c('grey80','#41f0ad'), name = 'Osa Bound') +
     scale_y_discrete(position = 'right', ) +
     xlab('Percent Bound by Osa') +
     theme(legend.position = 'top',
           legend.key.size = unit(1, 'cm'),
           legend.text = element_text(size = 15),
           legend.title = element_text(size = 20), 
           panel.background = element_blank(),
           axis.text = element_blank(),
           axis.title = element_blank(),
           axis.ticks = element_blank(),
#           axis.text.y = element_text(size = 12),
           panel.grid = element_blank()) + 
     NULL
   fn = paste0('rPlots/3E_',i,'.png')
   ggsave(fn, width = 6, height = 1.5, units = 'in', dpi = 300 )
   })
}
```

## .bed out
```{r setup}
osaPeaks %>%
  data.frame() %>%
  dplyr::select(seqnames, start, end) %>%
  write.table('osaPeaks.bed', quote = F, col.names = F, row.names = F, sep = '\t')

osaPeaks.full %>%
  data.frame() %>%
  dplyr::select(seqnames, start, end) %>%
  write.table('osaPeaks-full.bed', quote = F, col.names = F, row.names = F, sep = '\t')

peaks$cnr.df %>%
  data.frame() %>%
  dplyr::filter(yw.cnr) %>%
  dplyr::select(seqnames, start, end) %>%
  write.table('controlPeaks.bed', quote = F, col.names = F, row.names = F, sep = '\t')

fairePeaks.osaDependent %>%
  data.frame() %>%
  dplyr::select(seqnames, start, end) %>%
  write.table('osaDependent.bed', quote = F, col.names = F, row.names = F, sep = '\t')

fairePeaks.osaEctopic %>%
  data.frame() %>%
  dplyr::select(seqnames, start, end) %>%
  write.table('osaEctopic.bed', quote = F, col.names = F, row.names = F, sep = '\t')

```


## gviz
```{r setup}
genetrack <- Gviz::GeneRegionTrack(range = dm6.TxDb, fill = 'grey80', showTitle = F, background.title = 'white', stacking = 'squish')

peakTrack <- Gviz::AnnotationTrack(range = osaPeaks.full, genome = 'dm6', fill = '#D01C8B', col = 'transparent', background.title = 'white', showTitle = F )

spacer <- Gviz::AnnotationTrack(background.title = 'white')
```

## matrices for heatmaps
```{r}
mats <- purrr::map(bws, ~{
  normalizeToMatrix(., osaPeaks, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
})
names(mats) <- names(bws)
```


# Fig 1

## B - brDisc browser shot

```{r, 1A}

#TODO - best way to generate replicate average signal tracks
#TODO - functionalize givz plotting -- see SLN e93 gof repo - wrote series of functions for browser shot plotting

#track.colors <- RColorBrewer::brewer.pal(n = 4, "PiYG")

faire.wt.browser <- faire.wt.ssPool %>%
  #dplyr::filter(grepl('3LW',time)) %>%
  dplyr::mutate(color = WTFAIRE.colors)

faire.wt.tracks <- get_cnr_tracks(faire.wt.browser, ylim = c(0,15))
faire.wt.tracks <- c(faire.wt.tracks$wt_3LW,
                     faire.wt.tracks$wt_6h,
                     faire.wt.tracks$wt_18h,
                     faire.wt.tracks$wt_24h,
                     faire.wt.tracks$wt_36h,
                     faire.wt.tracks$wt_44h)

brdisc.at <- Gviz::AnnotationTrack(range = brD, genome = 'dm6', name = 'brDisc', fill = '#e858a5', col = 'transparent', background.title = 'white', showTitle = F )

axis <- Gviz::GenomeAxisTrack(scale = 10000)


png('rPlots/1B.png', width = 14, height = 8, res = 300, units = 'in')
Gviz::plotTracks(c(axis,faire.wt.tracks, brdisc.at, genetrack), chromosome = seqnames(brD) %>% as.character(), 
                 from = start(brD + 20000),
                 to = end(brD + 20000),
                 cex.axis = 0.3,
                 cex.title = 0.5,
                 title.width = 1,
                 innerMargin = 10)
dev.off()

```

## C - brD adjacent gene expression
```{r}
wing.rnaseq %>%
  dplyr::select(-log_mean,-mean) %>%
  tidyr::pivot_longer(!Geneid) %>%
  dplyr::filter(Geneid %in% c('FBgn0025390','FBgn0283451')) %>%
  dplyr::group_by(name) %>%
  dplyr::mutate(name = stringr::str_remove(name,'X'),
                grp = stringr::str_split_fixed(name,'_',n=2)[[1]],
                grp = factor(grp, levels = c('L3', '6h','18h','24h','36h','44h')),
                Gene = dplyr::case_when(Geneid == 'FBgn0025390' ~ 'mur2b',
                                        Geneid == 'FBgn0283451' ~ 'br')) %>%
  dplyr::group_by(Gene, grp) %>%
  dplyr::summarise(mean = mean(value)) %>%
  dplyr::mutate(fracmax = mean/max(mean)) %>%
  ggplot(aes(grp, fracmax, color = Gene, group = Gene)) +
  geom_line(size = 2) +
  theme(axis.title = element_blank(),
        axis.text = element_text(size = 20),
        panel.grid.major = element_line(color = 'grey80'),
        legend.key.size = unit(1, 'cm'),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 20))

ggsave('rPlots/1C.png', dpi = 300, width = 7, height = 5)
```
# Fig 2
TODO - need to move image analys R code here

# Fig 3
## A - Osa CUT&RUN Venn
```{r}
# Overlaps for Venn -- draw venn manually in Illustrator
ChIPpeakAnno::makeVennDiagram(list(peaks$cnr.df %>% dplyr::filter(yw.cnr) %>% GRanges(),
                                   peaks$cnr.df %>% dplyr::filter(osa.cnr) %>% GRanges()))
```
## B - Osa CUT&RUN Heatmap
```{r, 3A}

#TODO - functionalize normalizetomatrix call, + common min/max and colorRamp

cnr.mats <- list(mats$yw.rep1, mats$osaGFP.rep1, mats$yw.rep2, mats$osaGFP.rep2) # correct order for subsequent names()
names(cnr.mats) <- cnr.ss$id

common_min = min(unlist(cnr.mats))
common_max = max(unlist(cnr.mats))

col_fun = circlize::colorRamp2(seq(common_min, common_max, length.out = 6), viridis.hex)

osa.count <- osaPeaks %>%
  data.frame() %>%
  nrow()

osa.count[1] <- as.character(osa.count[1])
  
names(osa.count) <- 'Osa Peak'

groups <- ifelse(osaPeaks$osa.cnr, 'Osa Peak', NA)

cnr.hms <- purrr::map(names(cnr.mats), function(x) {
  if(x == 'osaGFP.rep1'){
    EnrichedHeatmap(cnr.mats[[x]],
                    axis_name = c(-2000, 0, 2000),
                    pos_line = F,
                    column_title = x,
                    col = col_fun,
                    name = 'zScore',
                    top_annotation = HeatmapAnnotation(enriched = anno_enriched(axis_param = list(side = 'left', facing = 'outside'), ylim = c(0,6))),
                    left_annotation = c(rowAnnotation(textbox = anno_textbox(align_to = groups,
                                                                             as.list(osa.count),
                                                                             side = 'left',
                                                                             background_gp = gpar(fill = NA, col = NA),
                                                                             gp = gpar(col = 'black'), 
                                                                             padding = unit(0, 'mm'))))) 
  } else {
    EnrichedHeatmap(cnr.mats[[x]],
                    axis_name = c(-2000, 0, 2000),
                    pos_line = F,
                    column_title = x,
                    col = col_fun, 
                    show_heatmap_legend = FALSE,
                    top_annotation = HeatmapAnnotation(enriched = anno_enriched(axis = F, ylim = c(0,6)))) 
  }
})
names(cnr.hms) <- names(cnr.mats)

hms.ordered <-cnr.hms$osaGFP.rep1 + cnr.hms$osaGFP.rep2 + cnr.hms$yw.rep1 + cnr.hms$yw.rep2

png('rPlots/3B.png', width = 6, height = 6, units = 'in', res = 300)
hms.ordered
dev.off()
```
## C - bar plot of genomic annotations

```{r, 3C-peak-location}
anno.df <- dplyr::bind_rows(data.frame(osaPeaks), data.frame(peaks$dm6.500bp)) %>%
  dplyr::filter(assay == 'cnr' & osa.cnr & !yw.cnr | assay == '500bp background') %>%
  dplyr::group_by(assay, anno.new) %>%
  dplyr::tally() %>%
  dplyr::mutate(pct = n/sum(n),
                 sum = sum(n),
                assay = ifelse(assay == 'cnr', 'Osa', '500bp Bkg')) 

anno.df %>%
  ggplot(aes(x = '', y = n, fill = anno.new)) +
  geom_bar(stat = 'identity', position = 'fill', color = 'black') +
  geom_text_repel(aes(label= ifelse(pct > 0.07, paste0(sprintf("%1.1f", pct*100),"%"),'')),
                  position=position_fill(vjust=0.5),
                  colour="black", size =5,
                  min.segment.length = 0,
                  force = 0.01,
                  force_pull = 1) +
  scale_fill_brewer(palette = 'Spectral') +
#  scale_fill_manual(values = cbPalette.ibm) +
  ylab('Fraction') +
  guides(fill = guide_legend(byrow = TRUE)) +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.key.size = unit(0.6, 'cm'),
        legend.spacing.y = unit(0.1, 'cm'),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title.y = element_blank(),
        panel.background = element_blank(),
        strip.text = element_text(size = 12)) +
  facet_grid(~assay)
ggsave('rPlots/3C.png', width = 4, height = 4, units = 'in', dpi = 300)

####
#stats
# two-proportion z-test -- are proportions of different annotations the same between background and osa cnr?
###



ztest <- purrr::map(unique(anno.df$anno.new), function(x) {
  df <- anno.df %>% dplyr::filter(anno.new == x) 
    
  bkg.count <- df[df$assay=='500bp Bkg',]$n
  bkg.trial <- df[df$assay=='500bp Bkg',]$sum
  cnr.count <- df[df$assay=='Osa',]$n
  cnr.trial <- df[df$assay=='Osa',]$sum   
  
  ztest <- prop.test(c(bkg.count, cnr.count), c(bkg.trial, cnr.trial), correct = F)
  
  out <- data.frame(anno = x,
                    p = ztest$p.value)
  return(out)
}) %>%
  dplyr::bind_rows() 


ztest %>%
  dplyr::mutate(logp = -log(p),
                sigp = signif(p, digits = 2), 
                anno = factor(anno, levels = c("3' UTR", 
                                               "5' UTR",
                                               "Distal Intergenic",
                                               "Downstream",
                                               "Exon",
                                               "Intron",
                                               "Promoter"))) %>%
  ggplot(aes('', y = anno, fill = p)) + 
  geom_tile() + 
  geom_text(aes(label = sigp)) +
  scale_fill_viridis_c(direction = -1, option = "heat") +
  xlab('pValue') + 
  theme(legend.position = 'none',
        axis.title.y = element_blank(), 
        axis.title.x = element_text(size = 12), 
        axis.text = element_text(size = 12), 
        axis.ticks = element_blank())
ggsave('rPlots/S3-annotation-zTest.png', width = 3, height = 5, dpi = 300)  
```


## D - brDisc Browser
```{r}

#TODO - best way to generate replicate average signal tracks
#TODO - functionalize givz plotting -- see SLN e93 gof repo - wrote series of functions for browser shot plotting

#track.colors <- RColorBrewer::brewer.pal(n = 4, "PiYG")
#track.colors <- c("#B8E186","#F1B6DA", "#4DAC26","#D01C8B")
track.colors <- c("grey40","#F1B6DA", "grey20","#D01C8B")

cnr.ss.browser <- cnr.ss %>%
  dplyr::mutate(color = track.colors)

cnr.tracks <- get_cnr_tracks(cnr.ss.browser, ylim = c(0,12))
cnr.tracks <- list(cnr.tracks$osaGFP.rep1, cnr.tracks$osaGFP.rep2, peakTrack, cnr.tracks$yw.rep1, cnr.tracks$yw.rep2)
names(cnr.tracks) <- c('osaGFP.rep1', 'osaGFP.rep2', 'osaPeaks', 'yw.rep1', 'yw.rep2')

brdisc.at <- Gviz::AnnotationTrack(range = brD, genome = 'dm6', name = 'brDisc', fill = 'grey', col = 'transparent', background.title = 'white', showTitle = F )

axis <- Gviz::GenomeAxisTrack(scale = 1000)

png('rPlots/3D.png', width = 4, height = 4, res = 300, units = 'in')
Gviz::plotTracks(c(axis, cnr.tracks, brdisc.at), chromosome = seqnames(brD) %>% as.character(), 
                 from = start(brD + 1000),
                 to = end(brD + 1000),
                 cex.axis = 0.3,
                 cex.title = 0.5,
                 title.width = 1,
                 innerMargin = 10)
dev.off()
```

## H - osa bound enhancers - FAIRE heatmap open vs closed
```{r 3LW-FAIRE-in-OsaPeaks}

osaPeaks.enhancers <- osaPeaks %>%
  data.frame() %>%
  dplyr::filter(anno.new %in% c('Distal Intergenic','Intron')) %>%
  GRanges()

wt.3lw.mat <- normalizeToMatrix(bws$wt_3LW, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
osa.1.mat <- normalizeToMatrix(bws$osaGFP.rep1, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
osa.2.mat <- normalizeToMatrix(bws$osaGFP.rep2, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
fig3d.mats <- list(wt.3lw.mat, osa.1.mat, osa.2.mat)
names(fig3d.mats) <- c('WT_3LW', 'Osa Rep1', 'Osa Rep2')
  
common_min = min(unlist(fig3d.mats))
common_max = max(unlist(fig3d.mats))

col_fun = circlize::colorRamp2(seq(common_min, common_max, length.out = 6), viridis.hex)

groups <- ifelse(osaPeaks.enhancers$WT.3LW, "Open", "Closed")

lgd = Legend(at = c("closed", "open"), legend_gp = gpar(fill = c('#fc5d63','#87d674')))

l3.count <- osaPeaks.enhancers %>%
  data.frame() %>%
  dplyr::group_by(osa.cnr, WT.3LW) %>%
  dplyr::count() %>%
  dplyr::mutate(WT_FAIRE_3LW = ifelse(WT.3LW, 'Open','Closed'),
                n = as.character(n)) %>%
  .$n

names(l3.count) = unique(groups)

fig3d.hms <- EnrichedHeatmap(fig3d.mats$WT_3LW,
                             axis_name = c(-2,0,+2),
                             pos_line = F,
                             column_title = '3LW-FAIRE',
                             col = viridis.hex,
                             width = unit(1.5, 'in'), 
                             left_annotation = c(rowAnnotation(textbox = anno_textbox(groups, 
                                                                                      as.list(l3.count), 
                                                                                      side = 'left',
                                                                                      background_gp = gpar(fill = NA, col = NA),
                                                                                      gp = gpar(col = 'black'), 
                                                                                      padding = unit(0, 'mm')))),
                                                 #rowAnnotation(groups = anno_block(gp = gpar(fill = c('#fc5d63','#87d674')), show_name = F))), 
                             top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis_param = list(side = 'left'))),  
                             row_title = NULL, 
                             name = 'FAIRE zScore') +
  EnrichedHeatmap(fig3d.mats$`Osa Rep1`,
                  axis_name = c(-2,0,+2),
                  pos_line = F,
                  column_title = 'Osa.1',
                  col = col_fun,
                  name = 'Osa zScore',
                  width = unit(0.5,'in'),
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis = F))) +
  EnrichedHeatmap(fig3d.mats$`Osa Rep2`,
                   axis_name = c(-2,0,+2),
                   pos_line = F,
                   column_title = 'Osa.2',
                   col = col_fun,
                   show_heatmap_legend = F, 
                   width = unit(0.5,'in'),
                   top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis_param = list(side = 'right'))))
  

png('rPlots/3H.png', width = 5, heigh = 6, units = 'in', res = 300)
ComplexHeatmap::draw(fig3d.hms, row_split = groups, annotation_legend_list = list(lgd), row_title = NULL, heatmap_legend_side = "bottom", merge_legend = T)
dev.off()


```

# Fig S3
## LFC Violin 
Drop this? not in text currently
```{r}

peaks$cnr.df %>%
  dplyr::filter(yw.cnr | osa.cnr) %>%
  dplyr::mutate(twofold = ifelse(log2FoldChange <= -1 | log2FoldChange >= 1, T, F),
                cat = dplyr::case_when(osa.cnr & !yw.cnr ~ 'Osa',
                                       !osa.cnr & yw.cnr ~ 'Control',
                                       T ~ 'Shared')) %>% 
  ggplot(aes(x = '',  log2FoldChange, fill = cat)) + 
#  ggplot(aes(x = '',  cnr.log2FoldChange)) + 
  geom_violin(position = 'identity', alpha = 0.3, scale = 'count') +
  scale_alpha_manual(values = c(0,0.2)) +
#  ylim(c(-2.25,2.25)) +
  scale_fill_manual(values = c('#C05066','#8AD04E','#608AE3')) +
  ylab("log2FoldChange(osaGFP / control)") +
  theme(#legend.position = "none",
        axis.title.x = element_blank(),
        axis.text = element_text(size = 12)) 

ggsave('rPlots/S3-LFC_Violin.png', width = 5, height = 5, dpi = 300)
```

## B - shared peaks heatmap Open vs Closed
```{r}
hm.peaks <- peaks$cnr.df %>%
  data.frame() %>%
  dplyr::filter(osa.cnr & yw.cnr) %>% # filter on shared peaks
  GRanges() %>%
  resize(width = 1, fix = 'center') # resize to 1bp at center

#TODO - cleanup with purrr
wt.3lw.mat <- normalizeToMatrix(bws$wt_3LW, 
                                hm.peaks, 
                                value_column = 'score', 
                                keep = c(0.01, 0.99), 
                                extend = 2000)
osa.1.mat <- normalizeToMatrix(bws$osaGFP.rep1, 
                               hm.peaks, 
                               value_column = 'score', 
                               keep = c(0.01, 0.99), 
                               extend = 2000)
osa.2.mat <- normalizeToMatrix(bws$osaGFP.rep2, 
                               hm.peaks, 
                               value_column = 'score', 
                               keep = c(0.01, 0.99), 
                               extend = 2000)
yw.1.mat <- normalizeToMatrix(bws$yw.rep1, 
                              hm.peaks,
                              value_column = 'score',
                              keep = c(0.01, 0.99), 
                              extend = 2000)
yw.2.mat <- normalizeToMatrix(bws$yw.rep2,
                              hm.peaks, 
                              value_column = 'score', 
                              keep = c(0.01, 0.99), 
                              extend = 2000)

SB.mats <- list(wt.3lw.mat, osa.1.mat, osa.2.mat, yw.1.mat,yw.2.mat) # set the order 
names(SB.mats) <- c('WT_3LW', 'Osa Rep1', 'Osa Rep2', 'yw rep1', 'yw rep2')
  
common_min = min(unlist(SB.mats))
common_max = max(unlist(SB.mats))

col_fun = circlize::colorRamp2(seq(common_min, common_max, length.out = 6), viridis.hex) # set scale

groups <- ifelse(hm.peaks$WT.3LW, "Open", "Closed")

lgd = Legend(at = c("closed", "open"), legend_gp = gpar(fill = c('#fc5d63','#87d674')))

# count open vs closed 
l3.count <- hm.peaks %>%
  data.frame() %>%
  dplyr::group_by(WT.3LW) %>%
  dplyr::count() %>%
  dplyr::mutate(WT_FAIRE_3LW = ifelse(WT.3LW, 'Open','Closed'),
                n = as.character(n)) %>%
  .$n

names(l3.count) = unique(groups)

#TODO - cleanup with purrr
SB.hms <- EnrichedHeatmap(SB.mats$WT_3LW,
                             axis_name = c(-2,0,+2),
                             pos_line = F,
                             column_title = '3LW-FAIRE',
                             col = viridis.hex,
                             width = unit(1.5, 'in'), 
                             left_annotation = c(rowAnnotation(textbox = anno_textbox(groups, 
                                                                                      as.list(l3.count), 
                                                                                      side = 'left',
                                                                                      background_gp = gpar(fill = NA, col = NA),
                                                                                      gp = gpar(col = 'black'), 
                                                                                      padding = unit(0, 'mm')))),
                                                 #rowAnnotation(groups = anno_block(gp = gpar(fill = c('#fc5d63','#87d674')), show_name = F))), 
                             top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,6), axis_param = list(side = 'left'))),  
                             row_title = NULL, 
                             name = 'FAIRE zScore') +
  EnrichedHeatmap(SB.mats$`Osa Rep1`,
                  axis_name = c(-2,0,+2),
                  pos_line = F,
                  column_title = 'Osa.1',
                  col = col_fun,
                  name = 'Osa zScore',
                  width = unit(0.5,'in'),
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,11), axis = F))) +
  EnrichedHeatmap(SB.mats$`Osa Rep2`,
                   axis_name = c(-2,0,+2),
                   pos_line = F,
                   column_title = 'Osa.2',
                   col = col_fun,
                   show_heatmap_legend = F, 
                   width = unit(0.5,'in'),
                   top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,11), axis = F))) +
    EnrichedHeatmap(SB.mats$`yw rep1`,
                  axis_name = c(-2,0,+2),
                  pos_line = F,
                  column_title = 'yw.1',
                  col = col_fun,
                  name = 'yw zScore',
                  width = unit(0.5,'in'),
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,11), axis = F))) +
  EnrichedHeatmap(SB.mats$`yw rep2`,
                   axis_name = c(-2,0,+2),
                   pos_line = F,
                   column_title = 'yw.2',
                   col = col_fun,
                   show_heatmap_legend = F, 
                   width = unit(0.5,'in'),
                   top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,11), axis_param = list(side = 'right'))))

png('rPlots/S3-sharedPeaks.png', width = 5, heigh = 6, units = 'in', res = 300)
ComplexHeatmap::draw(SB.hms, row_split = groups, annotation_legend_list = list(lgd), row_title = NULL, heatmap_legend_side = "bottom", merge_legend = T)
dev.off()


```
## C - control specific peaks
```{r}
osaPeaks.enhancers <- peaks$cnr.df %>%
  data.frame() %>%
  dplyr::filter(yw.cnr & !osa.cnr) %>% # control specific peaks
  GRanges() %>%
  resize(width = 1, fix = 'center')


wt.3lw.mat <- normalizeToMatrix(bws$wt_3LW, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
osa.1.mat <- normalizeToMatrix(bws$osaGFP.rep1, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
osa.2.mat <- normalizeToMatrix(bws$osaGFP.rep2, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
yw.1.mat <- normalizeToMatrix(bws$yw.rep1, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
yw.2.mat <- normalizeToMatrix(bws$yw.rep2, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
fig3d.mats <- list(wt.3lw.mat, osa.1.mat, osa.2.mat, yw.1.mat,yw.2.mat)
names(fig3d.mats) <- c('WT_3LW', 'Osa Rep1', 'Osa Rep2', 'yw rep1', 'yw rep2')
  
common_min = min(unlist(fig3d.mats))
common_max = max(unlist(fig3d.mats))

col_fun = circlize::colorRamp2(seq(common_min, common_max, length.out = 6), viridis.hex)

groups <- ifelse(osaPeaks.enhancers$WT.3LW, "Open", "Closed")

lgd = Legend(at = c("closed", "open"), legend_gp = gpar(fill = c('#fc5d63','#87d674')))

l3.count <- osaPeaks.enhancers %>%
  data.frame() %>%
  dplyr::group_by(WT.3LW) %>%
  dplyr::count() %>%
  dplyr::mutate(WT_FAIRE_3LW = ifelse(WT.3LW, 'Open','Closed'),
                n = as.character(n)) %>%
  .$n

names(l3.count) = unique(groups)

fig3d.hms <- EnrichedHeatmap(fig3d.mats$WT_3LW,
                             axis_name = c(-2,0,+2),
                             pos_line = F,
                             column_title = '3LW-FAIRE',
                             col = viridis.hex,
                             width = unit(1.5, 'in'), 
                             left_annotation = c(rowAnnotation(textbox = anno_textbox(groups, 
                                                                                      as.list(l3.count), 
                                                                                      side = 'left',
                                                                                      background_gp = gpar(fill = NA, col = NA),
                                                                                      gp = gpar(col = 'black'), 
                                                                                      padding = unit(0, 'mm')))),
                                                 #rowAnnotation(groups = anno_block(gp = gpar(fill = c('#fc5d63','#87d674')), show_name = F))), 
                             top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,4.5), axis_param = list(side = 'left'))),  
                             row_title = NULL, 
                             name = 'FAIRE zScore') +
  EnrichedHeatmap(fig3d.mats$`Osa Rep1`,
                  axis_name = c(-2,0,+2),
                  pos_line = F,
                  column_title = 'Osa.1',
                  col = col_fun,
                  name = 'Osa zScore',
                  width = unit(0.5,'in'),
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis = F))) +
  EnrichedHeatmap(fig3d.mats$`Osa Rep2`,
                   axis_name = c(-2,0,+2),
                   pos_line = F,
                   column_title = 'Osa.2',
                   col = col_fun,
                   show_heatmap_legend = F, 
                   width = unit(0.5,'in'),
                   top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis = F))) +
    EnrichedHeatmap(fig3d.mats$`yw rep1`,
                  axis_name = c(-2,0,+2),
                  pos_line = F,
                  column_title = 'yw.1',
                  col = col_fun,
                  name = 'yw zScore',
                  width = unit(0.5,'in'),
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis = F))) +
  EnrichedHeatmap(fig3d.mats$`yw rep2`,
                   axis_name = c(-2,0,+2),
                   pos_line = F,
                   column_title = 'yw.2',
                   col = col_fun,
                   show_heatmap_legend = F, 
                   width = unit(0.5,'in'),
                   top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis_param = list(side = 'right'))))

png('rPlots/S3-control_specific.png', width = 5, heigh = 6, units = 'in', res = 300)
ComplexHeatmap::draw(fig3d.hms, row_split = groups, annotation_legend_list = list(lgd), row_title = NULL, heatmap_legend_side = "bottom", merge_legend = T)
dev.off()


```

## D - All osa bound - FAIRE heatmaps open vs closed
```{r 3LW-FAIRE-in-OsaPeaks}

osaPeaks.enhancers <- osaPeaks %>%
  data.frame() %>%
  GRanges()

#fig3d.mats <- list(mats$wt_3LW, mats$osaGFP.rep1, mats$osaGFP.rep2)
wt.3lw.mat <- normalizeToMatrix(bws$wt_3LW, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
osa.1.mat <- normalizeToMatrix(bws$osaGFP.rep1, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
osa.2.mat <- normalizeToMatrix(bws$osaGFP.rep2, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
fig3d.mats <- list(wt.3lw.mat, osa.1.mat, osa.2.mat)
names(fig3d.mats) <- c('WT_3LW', 'Osa Rep1', 'Osa Rep2')
  
common_min = min(unlist(fig3d.mats))
common_max = max(unlist(fig3d.mats))

col_fun = circlize::colorRamp2(seq(common_min, common_max, length.out = 6), viridis.hex)

groups <- ifelse(osaPeaks.enhancers$WT.3LW, "Open", "Closed")

lgd = Legend(at = c("closed", "open"), legend_gp = gpar(fill = c('#fc5d63','#87d674')))

l3.count <- osaPeaks.enhancers %>%
  data.frame() %>%
  dplyr::group_by(osa.cnr, WT.3LW) %>%
  dplyr::count() %>%
  dplyr::mutate(WT_FAIRE_3LW = ifelse(WT.3LW, 'Open','Closed'),
                n = as.character(n)) %>%
  .$n

names(l3.count) = unique(groups)

fig3d.hms <- EnrichedHeatmap(fig3d.mats$WT_3LW,
                             axis_name = c(-2,0,+2),
                             pos_line = F,
                             column_title = '3LW-FAIRE',
                             col = viridis.hex,
                             width = unit(1.5, 'in'), 
                             left_annotation = c(rowAnnotation(textbox = anno_textbox(groups, 
                                                                                      as.list(l3.count), 
                                                                                      side = 'left',
                                                                                      background_gp = gpar(fill = NA, col = NA),
                                                                                      gp = gpar(col = 'black'), 
                                                                                      padding = unit(0, 'mm')))),
                                                 #rowAnnotation(groups = anno_block(gp = gpar(fill = c('#fc5d63','#87d674')), show_name = F))), 
                             top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis_param = list(side = 'left'))),  
                             row_title = NULL, 
                             name = 'FAIRE zScore') +
  EnrichedHeatmap(fig3d.mats$`Osa Rep1`,
                  axis_name = c(-2,0,+2),
                  pos_line = F,
                  column_title = 'Osa.1',
                  col = col_fun,
                  name = 'Osa zScore',
                  width = unit(0.5,'in'),
                  top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis = F))) +
  EnrichedHeatmap(fig3d.mats$`Osa Rep2`,
                   axis_name = c(-2,0,+2),
                   pos_line = F,
                   column_title = 'Osa.2',
                   col = col_fun,
                   show_heatmap_legend = F, 
                   width = unit(0.5,'in'),
                   top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')), ylim = c(0,7), axis_param = list(side = 'right'))))
  

png('rPlots/3H-all.png', width = 5, heigh = 6, units = 'in', res = 300)
ComplexHeatmap::draw(fig3d.hms, row_split = groups, annotation_legend_list = list(lgd), row_title = NULL, heatmap_legend_side = "bottom", merge_legend = T)
dev.off()


```