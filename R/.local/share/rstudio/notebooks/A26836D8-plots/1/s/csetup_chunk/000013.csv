"0","library(magrittr)"
"0","library(ggplot2)"
"0","#library(ggrepel)"
"0","library(GenomicRanges)"
"0",""
"0","library(org.Dm.eg.db)"
"0","library(AnnotationDbi)"
"0",""
"0","library(EnrichedHeatmap)"
"0","library(ComplexHeatmap)"
"0",""
"0","#library(GO.db)"
"0",""
"0","#library(patchwork)"
"0",""
"0","source('utils.R')"
"0","source('NystLib/R/peakUtils.R') #TODO move/rewrite getPeakData from NystLib to utils.R"
"0",""
"0","## load data"
"0",""
"0","load('rData/sheets.rda')"
"0","load('rData/peaks.rda')"
"2","Warning in for (pair in pairs) { :"
"2","
 "
"2"," closing unused connection 3 (~/McKay/Motif_databases/FLY/fly_factor_survey.meme)
"
"0","load('rData/rnaiScreen.rda')"
"0",""
"0","#TODO move RNAseq data into BAP project"
"0","# TODO this is in progress - mixed across directories"
"0","load('rData/wing-rnaseq-GeTMM.RData')  # GeTMM normalized RNAseq"
"0","#loads 'wing.rnaseq'"
"0",""
"0","#load('rData/wing-rnaseq-DDS.RData')  # loads dds.results "
"0","## TODO -- no id validation yet need to fix"
"0","#rna.dds <- dds.results %>%"
"0","#  dplyr::filter(baseMean_6h > 0) %>%"
"0","#  tibble::rownames_to_column(var = 'Geneid')"
"0",""
"0","ON.genes <- wing.rnaseq %>%"
"0","  dplyr::filter(mean >= 2) %>%"
"0","  dplyr::select(Geneid) "
"0",""
"0","ON.genes %>% write.table('on-rnaseq.txt', sep = '\n', row.names = F, col.names = F, quote = F)"
"0","#TODO clean this up - had to write out the on list and use the flybase id validator tool... "
"0","ON.genes.validated <- read.table('Wing-RNAseq/on-genes-IDvalidation.txt', header = T) %>%"
"0","  dplyr::rename(Geneid = submitted_item, "
"0","                Validated = validated_id,"
"0","                Symbol = current_symbol)"
"0",""
"0","#TODO move flyfactor database to BAP - code to download to repo?"
"0","## load in a flyfacotr fbgn validated .txt - generated with Flybase id validator"
"0",""
"0","## there are 2 'FlyFactor' FBgn codes that are updated two more than 1 unique 'Validated' FBgns in `fbgn.validated`"
"0","# FBgn0051782 -- CG31782 in flyfactor - old annotation? no present in Flybase, maybe split into three differen pseudogene annos now"
"0","# FBgn0050420 -- is only Atf-2 in flyfactor db"
"0","fbgn.validated <- read.table('fbgn_validated.txt', header = F, sep = '\t')"
"0","colnames(fbgn.validated) <- c('FlyFactor', 'Validated', 'Symbol')"
"0","fbgn.validated %<>% "
"0","  dplyr::filter(FlyFactor != 'FBgn0051782') %>% #drop this FBgn, problematic update to multiple new FBgns of pseudogenes"
"0","  dplyr::filter(Validated != 'FBgn0265182') # drop this Validated FBgn, which is an incorrectly updated from FBgn0050420"
"0",""
"0","## global variables"
"0","###"
"0","# assign global variables"
"0","###"
"0",""
"0","dm6 <- BSgenome.Dmelanogaster.UCSC.dm6::BSgenome.Dmelanogaster.UCSC.dm6"
"0","#dm3 <- BSgenome.Dmelanogaster.UCSC.dm3::BSgenome.Dmelanogaster.UCSC.dm3"
"0","dm6.TxDb <- TxDb.Dmelanogaster.UCSC.dm6.ensGene::TxDb.Dmelanogaster.UCSC.dm6.ensGene"
"0",""
"0","dm6.promoters <- ChIPseeker::getPromoters(dm6.TxDb, upstream = 500, downstream = 100) "
"0","dm6.genes <- GenomicFeatures::genes(dm6.TxDb)"
"2","  1 gene was dropped because it has exons located on both strands of the same reference sequence or on
  more than one reference sequence, so cannot be represented by a single genomic range.
  Use 'single.strand.genes.only=FALSE' to get all the genes in a GRangesList object, or use
  suppressMessages() to suppress this message.
"
"0","brD <- data.frame('seqnames' = 'chrX',"
"0","                  'start' = 1565708,"
"0","                  'end' = 1567401) %>%"
"0","  GenomicRanges::GRanges()"
"0",""
"0","shn <- data.frame('seqnames' = 'chr2R',"
"0","                  'start' = 11159086,"
"0","                  'end' = 11217394) %>% "
"0","  GRanges()"
"0",""
"0","sbb <- data.frame('seqnames' = 'chr2R',"
"0","                  'start' = 18278198,"
"0","                  'end' = 18357296) %>%"
"0","  GRanges()"
"0",""
"0","# Dl "
"0","#chr3R:19,265,389-19,350,508"
"0","Dl <- data.frame('seqnames' = 'chr3R',"
"0","                  'start' = 19265389,"
"0","                  'end' = 19350508) %>%"
"0","  GRanges()"
"0",""
"0",""
"0","# E(spl)-c"
"0","#chr3R:25,980,255-26,065,374"
"0","espl <- data.frame('seqnames' = 'chr3R',"
"0","                  'start' = 25980255,"
"0","                  'end' = 26065374) %>%"
"0","  GRanges()"
"0",""
"0","# ac/sc"
"0","#chrX:365,344-402,061"
"0","acsc <- data.frame('seqnames' = 'chrX',"
"0","                   'start' = 365344,"
"0","                   'end' = 402061) %>%"
"0","  GRanges()"
"0",""
"0","# serrate"
"0","#chr3R:27,167,731-27,227,610"
"0","ser <- data.frame('seqnames' = 'chr3R',"
"0","                  'start' = 27167731,"
"0","                  'end' = 27227610) %>%"
"0","  GRanges()"
"0",""
"0","# notch"
"0","#chrX:3,093,887-3,206,341"
"0","notch <- data.frame('seqnames' = 'chrX',"
"0","                    'start' = 3093887,"
"0","                    'end' = 3206341) %>%"
"0","  GRanges()"
"0","### "
"0",""
"0","# nubbin"
"0","#chr2L:12,542,935-12,696,192"
"0","nub <- data.frame('seqnames' = 'chr2L',"
"0","                    'start' = 12542935,"
"0","                    'end' = 12696192) %>%"
"0","  GRanges()"
"0","# enhancers"
"0","### "
"0",""
"0","redFly_enhancers <- read.table('bed/all_Dmel_CRM-sorted-merged.bed', sep = '\t')"
"0","colnames(redFly_enhancers) <- c('seqnames', 'start','end')"
"0","redFly_enhancers.ranges <- GRanges(redFly_enhancers)"
"0",""
"0",""
"0",""
"0","## memes setup"
"0","### "
"0","# meme db "
"0","###"
"0","#TODO - so clunky..."
"0","# loading in the fly factor database, drop out a couple of problematic fbgn"
"0","# then use the fbgn.validated lookup table for fly factor to update all the old ids to correct ids"
"0","# then filter on the on gene list -- which has to go through a similar process of id validation"
"0","# gross"
"0","meme_db <- universalmotif::read_meme('fly_factor_survey.meme') %>%"
"0","  universalmotif::to_df() %>%"
"0","  dplyr::group_by(name) %>%"
"0","  dplyr::filter(!grepl('FBgn0051782|FBgn0265182', name)) %>%  #drop this FBgn, problematic update to multiple new FBgns of pseudogenes"
"0","  dplyr::mutate(basename = stringr::str_split_fixed(name, '_', n = 2)[[1]],"
"0","                fbgn.validated = fbgn.validated[fbgn.validated$FlyFactor == basename,]$Validated) "
"0",""
"0","meme_db_on <- meme_db %>%"
"0","  dplyr::filter(fbgn.validated %in% ON.genes.validated$Validated)"
"0",""
"0","options(meme_db = universalmotif::to_list(meme_db_on, extrainfo = F))"
"2","Discarding unknown slot(s) 'eval.string', 'basename', 'fbgn.validated' (set `extrainfo=TRUE` to preserve
  these).
"
"0","## colors"
"0","viridis.hex <- c(""#440154"",""#3b528b"",""#21918c"",""#5ec962"",""#5ec962"",""#fde725"")"
"0","cbPalette <- c(""#999999"", ""#E69F00"", ""#56B4E9"", ""#009E73"", ""#F0E442"", ""#0072B2"", ""#D55E00"", ""#CC79A7"")"
"0","cbPalette.4 <- c(""#D81B60"",""#1E88E5"",""#FFC107"",""#004D40"")"
"0","cbPalette.ibm <- c('#332288','#117733','#44AA99','#88CCEE','#DDCC77','#CC6677','#AA4499','#882255')"
"0",""
"0","## browser "
"0","WTFAIRE.colors <- c(""grey10"",""grey20"",""grey30"",""grey40"",""grey50"",""grey60"")"
"0",""
"0","## peak subsets"
"0","osaPeaks <- peaks$cnr.df %>% "
"0","  dplyr::filter(osa.cnr & !yw.cnr) %>% "
"0","  GRanges() %>% "
"0","  resize(width = 1, fix = ""center"")"
"0",""
"0","osaPeaks.full <- peaks$cnr.df %>% "
"0","  dplyr::filter(osa.cnr & !yw.cnr) %>% "
"0","  GRanges(seqlengths = seqlengths(dm6))"
"0",""
"0","osaPeaks.enhancers.full <- osaPeaks.full %>%"
"0","  data.frame() %>%"
"0","  dplyr::filter(anno.new %in% c('Distal Intergenic', 'Intron')) %>%"
"0","  GRanges()"
"0",""
"0","# uses rep1 summit coordinates "
"0","osaPeaks.summits <- subsetByOverlaps(cnr.summits, osaPeaks.full)"
"0","osaPeaks.faire.summits <- subsetByOverlaps(faire.wt.3LW.summits, osaPeaks.full)"
"0",""
"0",""
"0","fairePeaks.wt <- peaks$faire.wt.df %>%"
"0","#  dplyr::filter(assay == 'faire' & experiment == 'WT FAIRE Wing Timecourse') %>%"
"0","  GRanges() %>%"
"0","  resize(width = 1, fix = ""center"")"
"0",""
"0","#redundant... but used in a couple chunks for motif analysis"
"0","fairePeaks.wt.full <- peaks$faire.wt.df %>% "
"0","  dplyr::filter(assay == 'faire'  & experiment == 'WT FAIRE Wing Timecourse')"
"0",""
"0",""
"0","#DONE - remove the peakCat ? since now using log2fold change for these categories..."
"0","# switched to using osaDeg.qF which is a peak set derived from diffbind, that has been subset using iranges by intersect"
"0","# with quality filtered peak calls in peaks$faire.osaDeg.df"
"0","osaDeg.center <- osaDeg.qF %>%"
"0","  GRanges() %>%"
"0","  resize(width = 1, fix = ""center"")"
"0",""
"0","# rotund peaks"
"0","rn.peaks <- peaks$rn.df %>% "
"0","  GRanges()"
"0",""
"0","rn.distal <- rn.peaks %>%"
"0","  dplyr::filter(anno.new %in% c('Distal Intergenic', 'Intron')) %>%"
"0","  GRanges()"
"0","# genomic 500bp"
"0",""
"0","dm6.500bp <- peaks$dm6.500bp %>%"
"0","  GRanges() %>%"
"0","  resize(width = 1, fix = 'center')"
"0","#fairePeaks.osaDependent <- fairePeaks.deg %>% "
"0","#  data.frame() %>% "
"0","#  dplyr::filter(faireCat.osaDeGrad == 'Osa Dependent') %>%"
"0","#  GRanges()"
"0","#"
"0","#fairePeaks.osaIndependent <- fairePeaks.deg %>%"
"0","#  data.frame() %>%"
"0","#  dplyr::filter(faireCat.osaDeGrad == 'Osa Independent') %>%"
"0","#  GRanges()"
"0","#"
"0","#fairePeaks.osaEctopic <- fairePeaks.deg %>%"
"0","#  data.frame() %>%"
"0","#  dplyr::filter(faireCat.osaDeGrad == 'Osa Ectopic') %>%"
"0","#  GRanges()"
"0",""
"0",""
"0",""
"0","## load bws "
"0",""
"0",""
"0","#TODO - cleanup - move matrices?"
"0",""
"0","bws <- get_bws(dplyr::bind_rows(cnr.ss, faire.wt.ssPool), 'id') "
"0",""
"0","deg.bws <- get_bws(faire.ss %>% dplyr::filter(experiment == 'osaGFP deGrad FAIRE'), 'id')"
"0",""
"0","#TODO move data to main project directory and fix path"
"0","#TODO merge reps?"
"0","#k27ac.bw <- rtracklayer::import.bw('~/mckay/h3k27ac_cnr/bigwig/yw-3LW-wing-ak27ac-pel-Rep1_dm6_trim_q5_dupsRemoved_allFrags_rpgcNorm_zNorm.bw') "
"0","#TODO put these notes in better place"""
"0","## K27ac data- yeast spikein norm pel data is generally lower in rep2 than rep1, this is not seen in znorm or drosYak norm data"
"0","## drosYak norm signal is ""low"" as in the absolute values are usually < 1, but the normalization between samples looks good, and the signal to noise still looks fine, not appreciably better or worse that znorm"
"0","## using pellet because only have 2 reps of pel, only 1 of sup - the sup rep looks really good though I think"
"0","## using large fragments only because all fractions/reps show poor signal in <120 bp frag split"
"0",""
"0","#k27ac.bw <- rtracklayer::import.bw('~/mckay/H3K27ac_CnR/BigWig/yw-3LW-wing-ak27ac-pel-MEAN_dm6_trim_q5_dupsRemoved_150to700_rpgcNorm_zNorm.bw') "
"0","k27ac.1.bw <- rtracklayer::import.bw('BigWig/yw-3LW-wing-ak27ac-pel-Rep1_dm6_trim_q5_dupsRemoved_150to700_rpgcNorm_zNorm.bw') "
"0","k27ac.2.bw <- rtracklayer::import.bw('BigWig/yw-3LW-wing-ak27ac-pel-Rep2_dm6_trim_q5_dupsRemoved_150to700_rpgcNorm_zNorm.bw') "
"0",""
"0","## functions "
"0",""
"0","plot.frac <- function(x) {"
"0"," lapply(unique(x$change), function(i) {"
"0","   x %>%"
"0","     dplyr::filter(change == i) %>%"
"0","     ggplot(aes(fraction, change, fill = Osa.Bound)) +"
"0","     geom_bar(stat = 'identity', width = 1) +"
"0","     geom_text(aes(label = per), position = position_fill(vjust = 0.6),  size = 7, fontface = ""bold"") +"
"0","     #geom_text(aes(label = per, position = position_stack(vjust = 0.5))) +"
"0","     scale_fill_manual(values = c('grey80','#41f0ad'), name = 'Osa Bound') +"
"0","     scale_y_discrete(position = 'right', ) +"
"0","     xlab('Percent Bound by Osa') +"
"0","     theme(legend.position = 'top',"
"0","           legend.key.size = unit(1, 'cm'),"
"0","           legend.text = element_text(size = 15),"
"0","           legend.title = element_text(size = 20), "
"0","           panel.background = element_blank(),"
"0","           axis.text = element_blank(),"
"0","           axis.title = element_blank(),"
"0","           axis.ticks = element_blank(),"
"0","#           axis.text.y = element_text(size = 12),"
"0","           panel.grid = element_blank()) + "
"0","     NULL"
"0","   fn = paste0('rPlots/3E_',i,'.png')"
"0","   ggsave(fn, width = 6, height = 1.5, units = 'in', dpi = 300 )"
"0","   })"
"0","}"
"0",""
"0","## .bed out"
"0","osaPeaks %>%"
"0","  data.frame() %>%"
"0","  dplyr::select(seqnames, start, end) %>%"
"0","  write.table('osaPeaks.bed', quote = F, col.names = F, row.names = F, sep = '\t')"
"0",""
"0","osaPeaks.full %>%"
"0","  data.frame() %>%"
"0","  dplyr::select(seqnames, start, end) %>%"
"0","  write.table('osaPeaks-full.bed', quote = F, col.names = F, row.names = F, sep = '\t')"
"0",""
"0","peaks$cnr.df %>%"
"0","  data.frame() %>%"
"0","  dplyr::filter(yw.cnr) %>%"
"0","  dplyr::select(seqnames, start, end) %>%"
"0","  write.table('controlPeaks.bed', quote = F, col.names = F, row.names = F, sep = '\t')"
"0",""
"0","#fairePeaks.osaDependent %>%"
"0","#  data.frame() %>%"
"0","#  dplyr::select(seqnames, start, end) %>%"
"0","#  write.table('osaDependent.bed', quote = F, col.names = F, row.names = F, sep = '\t')"
"0","#"
"0","#fairePeaks.osaEctopic %>%"
"0","#  data.frame() %>%"
"0","#  dplyr::select(seqnames, start, end) %>%"
"0","#  write.table('osaEctopic.bed', quote = F, col.names = F, row.names = F, sep = '\t')"
"0","#"
"0",""
"0",""
"0","## gviz"
"0","track.colors <- c(""grey40"",""#D01C8B"", ""grey40"",""#D01C8B"")"
"0",""
"0","cnr.ss.browser <- cnr.ss %>% dplyr::mutate(color = track.colors)"
"0",""
"0","mckay_enhancers <- read.table('bed/cloned_enhancers_dm6.bed', sep = '\t')"
"0","Delta_enhancers <- read.table('bed/cloned_Delta_enhancers.bed', sep = '\t')"
"0","espl_enhancers <- read.table('bed/espl_enhancers-merge.bed', sep = '\t')"
"0",""
"0","enhancers <- dplyr::bind_rows(Delta_enhancers, espl_enhancers)"
"0","colnames(enhancers) <- c('seqnames', 'start','end','name')"
"0","enhancer.ranges <- GRanges(enhancers)"
"0",""
"0","enhancertrack <- Gviz::AnnotationTrack(range = enhancer.ranges,"
"0","                                      genome = 'dm6',"
"0","                                      fill = '#18c708',"
"0","                                      col = 'transparent',"
"0","                                      background.title = 'white',"
"0","                                      showTitle = F)"
"0",""
"0","genetrack <- Gviz::GeneRegionTrack(range = dm6.TxDb, fill = 'grey80', showTitle = F, background.title = 'white', stacking = 'squish')"
"0",""
"0","peakTrack <- Gviz::AnnotationTrack(range = osaPeaks.full, "
"0","                                   genome = 'dm6', "
"0","                                   fill = '#D01C8B', "
"0","                                   col = 'transparent', "
"0","                                   background.title = 'white', "
"0","                                   showTitle = F )"
"0",""
"0","#TODO - is osa.dependent annotation correct? using diffbind?"
"0","osaDep.peakTrack <- Gviz::AnnotationTrack(range = GRanges(peaks$faire.osaDeg.df %>% dplyr::filter(osa.dependent)), "
"0","#osaDep.peakTrack <- Gviz::AnnotationTrack(range = osaDeg.osaDep, "
"0","                                          genome = 'dm6', "
"0","                                          fill = '#469ae8', "
"0","                                          col = 'transparent',"
"0","                                          background.title = 'white', "
"0","                                          showTitle = F)"
"0",""
"0","hairless_peaks <- read.table('bed/hairless-dm6.bed', col.names = c('seqnames', 'start', 'end')) %>% GRanges()"
"0",""
"0","hTrack <- Gviz::AnnotationTrack(range = hairless_peaks,"
"0","                                genome = 'dm6',"
"0","                                fill = '#2ad4c3',"
"0","                                col = 'transparent',"
"0","                                background.title = 'white',"
"0","                                showTitle = F)"
"0",""
"0","spacer <- Gviz::AnnotationTrack(background.title = 'white')"
"0",""
"0","## matrices for heatmaps"
"0",""
"0","mats <- purrr::map(bws, ~{"
"0","  normalizeToMatrix(., osaPeaks, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)"
"0","})"
"0","names(mats) <- names(bws)"
