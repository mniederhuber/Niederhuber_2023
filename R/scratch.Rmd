```{r setup}
library(magrittr)
library(ggplot2)
library(GenomicRanges)

library(org.Dm.eg.db)
library(AnnotationDbi)

library(EnrichedHeatmap)
library(ComplexHeatmap)

source('utils.R')

dm6 <- BSgenome.Dmelanogaster.UCSC.dm6::BSgenome.Dmelanogaster.UCSC.dm6
dm6.TxDb <- TxDb.Dmelanogaster.UCSC.dm6.ensGene::TxDb.Dmelanogaster.UCSC.dm6.ensGene

load('rData/sheets.rda')
load('rData/peaks.rda')

brD <- data.frame('seqnames' = 'chrX',
                  'start' = 1565708,
                  'end' = 1567401) %>%
  GenomicRanges::GRanges()




```

# Fig 3A. - heatmap of osa binding sites vs control

```{r 3A}

#TODO -- what can be functionalized here? -- EnrichedHeatmap() calls? -- definitely normalizeToMatrix()

viridis.hex <- c("#440154","#3b528b","#21918c","#5ec962","#5ec962","#fde725")

bws <- purrr::map(cnr.ss$id, function(x) {
  #fp <- cnr.ss[cnr.ss['id'] == x,]$bigwig_allFrags_sacCer3_spikeNorm
  fp <- cnr.ss[cnr.ss['id'] == x,]$zNorm_bigwig_allFrags_rpgcNorm
  rtracklayer::import.bw(fp)
})

names(bws) <- cnr.ss$id

osaPeaks <- peaks %>% dplyr::filter(osa.cnr & !yw.cnr & assay == 'cnr') %>% GRanges() %>% resize(width = 1, fix = "center")

mats <- purrr::map(bws, function(x) {
  normalizeToMatrix(x, osaPeaks, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
}) 
names(mats) <- names(bws)

common_min = min(unlist(mats))
common_max = max(unlist(mats))

col_fun = circlize::colorRamp2(seq(common_min, common_max, length.out = 6), viridis.hex)

osa.count <- osaPeaks %>%
  data.frame() %>%
  nrow()

osa.count[1] <- as.character(osa.count[1])
  
names(osa.count) <- 'Osa Peak'

groups <- ifelse(osaPeaks$osa.cnr, 'Osa Peak', NA)

hms <- purrr::map(names(mats), function(x) {
  if(x == 'osaGFP.rep1'){
    EnrichedHeatmap(mats[[x]],
                    axis_name = c(-2000, 0, 2000),
                    pos_line = F,
                    column_title = x,
                    col = col_fun,
                    name = 'zScore',
                    top_annotation = HeatmapAnnotation(enriched = anno_enriched(axis_param = list(side = 'left', facing = 'outside'), ylim = c(0,6))),
                    left_annotation = c(rowAnnotation(textbox = anno_textbox(align_to = groups,
                                                                             as.list(osa.count),
                                                                             side = 'left',
                                                                             background_gp = gpar(fill = NA, col = NA),
                                                                             gp = gpar(col = 'black'), 
                                                                             padding = unit(0, 'mm'))))) 
  } else {
    EnrichedHeatmap(mats[[x]],
                    axis_name = c(-2000, 0, 2000),
                    pos_line = F,
                    column_title = x,
                    col = col_fun, 
                    show_heatmap_legend = FALSE,
                    top_annotation = HeatmapAnnotation(enriched = anno_enriched(axis = F, ylim = c(0,6)))) 
  }
})
names(hms) <- names(mats)

hms.ordered <- hms$osaGFP.rep1 + hms$osaGFP.rep2 + hms$yw.rep1 + hms$yw.rep2

png('rPlots/bwSignal_OsaPeaks.png', width = 6, height = 6, units = 'in', res = 300)
hms.ordered
dev.off()
```

# Fig 3B. - br enhancer browswer shot

```{r, fig.width=4, fig.height=3}

#TODO - best way to generate replicate average signal tracks
#TODO - functionalize givz plotting -- see SLN e93 gof repo - wrote series of functions for browser shot plotting

#track.colors <- RColorBrewer::brewer.pal(n = 4, "PiYG")
track.colors <- c("#B8E186","#F1B6DA", "#4DAC26","#D01C8B")

cnr.ss.browser <- cnr.ss %>%
  dplyr::mutate(color = track.colors)

cnr.tracks <- get_cnr_tracks(cnr.ss.browser, ylim = c(0,12))

brdisc.at <- Gviz::AnnotationTrack(range = brD, genome = 'dm6', name = 'brDisc', fill = 'grey', col = 'transparent', background.title = 'white', showTitle = F )

axis <- Gviz::GenomeAxisTrack(scale = 1000)

png('rPlots/brD_shot.png', width = 4, height = 4, res = 300, units = 'in')
Gviz::plotTracks(c(axis, cnr.tracks, brdisc.at), chromosome = seqnames(brD) %>% as.character(), 
                 from = start(brD + 1000),
                 to = end(brD + 1000),
                 cex.axis = 0.3,
                 cex.title = 0.5,
                 title.width = 1,
                 innerMargin = 10)
dev.off()
```

# Fig 3C. Where are osaGFP binding sites?
  - bed file
  - browser shots
  - proximity to TSS vs distal
  
```{r peak-location}
# distribution of feature annotations
 peaks %>%
  dplyr::filter(assay == 'cnr' &  osa.cnr & !yw.cnr | assay == '1kb background') %>%
  dplyr::group_by(anno.new, assay) %>%
  dplyr::count() %>%
  ggplot(aes(x = assay, y = n, fill = anno.new)) +
  geom_bar(stat = 'identity', position = 'fill') +
  scale_fill_manual(values = cbPalette) +
  ylab('Fraction') +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank(),)
ggsave('rPlots/osaPeak_annotation.png', width = 4, height = 4, units = 'in', dpi = 300)

```








```