axis = F,
axis_param = list(side = 'left'))),
row_title = NULL,
name = 'FAIRE zScore') +
EnrichedHeatmap(fig3d.mats$`Osa Rep1`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.1',
col = col_fun,
name = 'Osa zScore',
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
axis = F))) +
EnrichedHeatmap(fig3d.mats$`Osa Rep2`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.2',
col = col_fun,
show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
# axis_param = list(side = 'right'))),
axis = F))) +
EnrichedHeatmap(fig3d.mats$K27ac,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'K27ac',
#col = col_fun,
col = circlize::colorRamp2(seq(0, 2.5, length.out = 6), viridis.hex),
name = 'H3K27ac zScore',
#show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,2.2),
axis = F,
axis_param = list(side = 'right')))) +
EnrichedHeatmap(fig3d.mats$K14ac,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'K27ac',
#col = col_fun,
col = circlize::colorRamp2(seq(0, 1, length.out = 6), viridis.hex),
name = 'H3K14ac zScore',
#show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(-0.5,0.5),
axis = F,
axis_param = list(side = 'right'))))
ComplexHeatmap::draw(fig3d.hms,
row_split = groups,
annotation_legend_list = list(lgd),
row_title = NULL,
heatmap_legend_side = "right",
merge_legend = T)
k14ac.mat <- normalizeToMatrix(k14ac.bw, osaPeaks.enhancers,
value_column = 'score',
keep = c(0.01, 0.99),
extend = 5000)
fig3d.hms <- EnrichedHeatmap(fig3d.mats$WT_3LW,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = '3LW-FAIRE',
col = viridis.hex,
width = unit(0.5, 'in'),
left_annotation = c(rowAnnotation(textbox = anno_textbox(groups,
as.list(l3.count),
side = 'left',
background_gp = gpar(fill = NA, col = NA),
gp = gpar(col = 'black'),
padding = unit(0, 'mm')))),
#rowAnnotation(groups = anno_block(gp = gpar(fill = c('#fc5d63','#87d674')), show_name = F))),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6),
axis = F,
axis_param = list(side = 'left'))),
row_title = NULL,
name = 'FAIRE zScore') +
EnrichedHeatmap(fig3d.mats$`Osa Rep1`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.1',
col = col_fun,
name = 'Osa zScore',
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
axis = F))) +
EnrichedHeatmap(fig3d.mats$`Osa Rep2`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.2',
col = col_fun,
show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
# axis_param = list(side = 'right'))),
axis = F))) +
EnrichedHeatmap(fig3d.mats$K27ac,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'K27ac',
#col = col_fun,
col = circlize::colorRamp2(seq(0, 2.5, length.out = 6), viridis.hex),
name = 'H3K27ac zScore',
#show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,2.2),
axis = F,
axis_param = list(side = 'right')))) +
EnrichedHeatmap(fig3d.mats$K14ac,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'K27ac',
#col = col_fun,
col = circlize::colorRamp2(seq(0, 1, length.out = 6), viridis.hex),
name = 'H3K14ac zScore',
#show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(-0.5,0.5),
axis = F,
axis_param = list(side = 'right'))))
ComplexHeatmap::draw(fig3d.hms,
row_split = groups,
annotation_legend_list = list(lgd),
row_title = NULL,
heatmap_legend_side = "right",
merge_legend = T)
k14ac.mat <- normalizeToMatrix(k14ac.bw, osaPeaks.enhancers,
value_column = 'score',
keep = c(0.01, 0.99),
extend = 10000)
fig3d.hms <- EnrichedHeatmap(fig3d.mats$WT_3LW,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = '3LW-FAIRE',
col = viridis.hex,
width = unit(0.5, 'in'),
left_annotation = c(rowAnnotation(textbox = anno_textbox(groups,
as.list(l3.count),
side = 'left',
background_gp = gpar(fill = NA, col = NA),
gp = gpar(col = 'black'),
padding = unit(0, 'mm')))),
#rowAnnotation(groups = anno_block(gp = gpar(fill = c('#fc5d63','#87d674')), show_name = F))),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6),
axis = F,
axis_param = list(side = 'left'))),
row_title = NULL,
name = 'FAIRE zScore') +
EnrichedHeatmap(fig3d.mats$`Osa Rep1`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.1',
col = col_fun,
name = 'Osa zScore',
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
axis = F))) +
EnrichedHeatmap(fig3d.mats$`Osa Rep2`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.2',
col = col_fun,
show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
# axis_param = list(side = 'right'))),
axis = F))) +
EnrichedHeatmap(fig3d.mats$K27ac,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'K27ac',
#col = col_fun,
col = circlize::colorRamp2(seq(0, 2.5, length.out = 6), viridis.hex),
name = 'H3K27ac zScore',
#show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,2.2),
axis = F,
axis_param = list(side = 'right')))) +
EnrichedHeatmap(fig3d.mats$K14ac,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'K27ac',
#col = col_fun,
col = circlize::colorRamp2(seq(0, 1, length.out = 6), viridis.hex),
name = 'H3K14ac zScore',
#show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(-0.5,0.5),
axis = F,
axis_param = list(side = 'right'))))
fig3d.hms <- EnrichedHeatmap(fig3d.mats$WT_3LW,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = '3LW-FAIRE',
col = viridis.hex,
width = unit(0.5, 'in'),
left_annotation = c(rowAnnotation(textbox = anno_textbox(groups,
as.list(l3.count),
side = 'left',
background_gp = gpar(fill = NA, col = NA),
gp = gpar(col = 'black'),
padding = unit(0, 'mm')))),
#rowAnnotation(groups = anno_block(gp = gpar(fill = c('#fc5d63','#87d674')), show_name = F))),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6),
axis = F,
axis_param = list(side = 'left'))),
row_title = NULL,
name = 'FAIRE zScore') +
EnrichedHeatmap(fig3d.mats$`Osa Rep1`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.1',
col = col_fun,
name = 'Osa zScore',
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
axis = F))) +
EnrichedHeatmap(fig3d.mats$`Osa Rep2`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.2',
col = col_fun,
show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
# axis_param = list(side = 'right'))),
axis = F))) +
EnrichedHeatmap(fig3d.mats$K27ac,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'K27ac',
#col = col_fun,
col = circlize::colorRamp2(seq(0, 2.5, length.out = 6), viridis.hex),
name = 'H3K27ac zScore',
#show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,2.2),
axis = F,
axis_param = list(side = 'right')))) +
EnrichedHeatmap(fig3d.mats$K14ac,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'K27ac',
#col = col_fun,
col = circlize::colorRamp2(seq(0, 1, length.out = 6), viridis.hex),
name = 'H3K14ac zScore',
#show_heatmap_legend = F,
width = unit(1,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(-0.5,0.5),
axis = F,
axis_param = list(side = 'right'))))
ComplexHeatmap::draw(fig3d.hms,
row_split = groups,
annotation_legend_list = list(lgd),
row_title = NULL,
heatmap_legend_side = "right",
merge_legend = T)
osaPeaks.enhancers <- osaPeaks %>%
data.frame() %>%
dplyr::filter(anno.new %in% c('Distal Intergenic','Intron')) %>%
GRanges()
#osaPeaks.enhancers <- subsetByOverlaps(faire.wt.3LW.summits, osaPeaks.enhancers)
wt.3lw.mat <- normalizeToMatrix(bws$wt_3LW, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
osa.1.mat <- normalizeToMatrix(bws$osaGFP.rep1, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
osa.2.mat <- normalizeToMatrix(bws$osaGFP.rep2, osaPeaks.enhancers, value_column = 'score', keep = c(0.01, 0.99), extend = 2000)
k27ac.mat <- normalizeToMatrix(k27ac.bw, osaPeaks.enhancers,
value_column = 'score',
keep = c(0.01, 0.99),
extend = 2000)
#k14ac.mat <- normalizeToMatrix(k14ac.bw, osaPeaks.enhancers,
#                               value_column = 'score',
#                               keep = c(0.01, 0.99),
#                               extend = 10000)
fig3d.mats <- list(wt.3lw.mat,
osa.1.mat,
osa.2.mat,
k27ac.mat)
# k14ac.mat)
names(fig3d.mats) <- c('WT_3LW',
'Osa Rep1',
'Osa Rep2',
'K27ac')
#'K14ac')
common_min = min(c(osa.1.mat, osa.2.mat))
common_max = max(c(osa.1.mat, osa.2.mat))
col_fun = circlize::colorRamp2(seq(common_min, common_max, length.out = 6), viridis.hex)
groups <- ifelse(osaPeaks.enhancers$WT.3LW, "Open", "Closed")
lgd = Legend(at = c("closed", "open"), legend_gp = gpar(fill = c('#fc5d63','#87d674')))
l3.count <- osaPeaks.enhancers %>%
data.frame() %>%
dplyr::group_by(osa.cnr, WT.3LW) %>%
dplyr::count() %>%
dplyr::mutate(WT_FAIRE_3LW = ifelse(WT.3LW, 'Open','Closed'),
n = as.character(n)) %>%
.$n
#
names(l3.count) = unique(groups)
fig3d.hms <- EnrichedHeatmap(fig3d.mats$WT_3LW,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = '3LW-FAIRE',
col = viridis.hex,
width = unit(0.5, 'in'),
left_annotation = c(rowAnnotation(textbox = anno_textbox(groups,
as.list(l3.count),
side = 'left',
background_gp = gpar(fill = NA, col = NA),
gp = gpar(col = 'black'),
padding = unit(0, 'mm')))),
#rowAnnotation(groups = anno_block(gp = gpar(fill = c('#fc5d63','#87d674')), show_name = F))),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6),
axis = F,
axis_param = list(side = 'left'))),
row_title = NULL,
name = 'FAIRE zScore') +
EnrichedHeatmap(fig3d.mats$`Osa Rep1`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.1',
col = col_fun,
name = 'Osa zScore',
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
axis = F))) +
EnrichedHeatmap(fig3d.mats$`Osa Rep2`,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'Osa.2',
col = col_fun,
show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,6.8),
# axis_param = list(side = 'right'))),
axis = F))) +
EnrichedHeatmap(fig3d.mats$K27ac,
axis_name = c(-2,0,+2),
pos_line = F,
column_title = 'K27ac',
#col = col_fun,
col = circlize::colorRamp2(seq(0, 2.5, length.out = 6), viridis.hex),
name = 'H3K27ac zScore',
#show_heatmap_legend = F,
width = unit(0.5,'in'),
top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
ylim = c(0,2.2),
axis = F,
axis_param = list(side = 'right'))))
#    EnrichedHeatmap(fig3d.mats$K14ac,
#                   axis_name = c(-2,0,+2),
#                   pos_line = F,
#                   column_title = 'K27ac',
#                   #col = col_fun,
#                   col = circlize::colorRamp2(seq(0, 1, length.out = 6), viridis.hex),
#                   name = 'H3K14ac zScore',
#                   #show_heatmap_legend = F,
#                   width = unit(1,'in'),
#                   top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = c('#fc5d63','#87d674')),
#                                                                            ylim = c(-0.5,0.5),
#                                                                            axis = F,
#                                                                            axis_param = list(side = 'right'))))
png('rPlots/3H.png', width = 5, heigh = 4, units = 'in', res = 300)
ComplexHeatmap::draw(fig3d.hms,
row_split = groups,
annotation_legend_list = list(lgd),
row_title = NULL,
heatmap_legend_side = "right",
merge_legend = T)
dev.off()
ComplexHeatmap::draw(fig3d.hms,
row_split = groups,
annotation_legend_list = list(lgd),
row_title = NULL,
heatmap_legend_side = "right",
merge_legend = T)
library(magrittr)
library(ggplot2)
library(viridis)
color_scale = c("#f0e932","#03d7fc","#1fb800", "#FFFFFF", "#f059a2")
brm_complex <- c('Bap111','brm','mor','Snr1','Act5C','Bap55')
pbap_complex <- c('polybromo', 'bap170')
bap_complex <- c('osa')
ino80 <- c('Arp5','Ino80','pho','Act5C')
dom <- c('dom','Tip60','Nipped-A','pont','Reptin')
atac <- c('Atac2','Atac3','D12','Wds','NC2beta')
NURF <- c('E(bx)', 'Nurf-38','ISWI','Caf1-55')
ACF <- c('Acf','Chrac-16')
NURD <- c('Mi-2','MTA1-like','Caf1-55')
NORC <- c('CtBP','Tou')
demethyl <- c('Jarid2','lid','su(var)3-3')
control <- c('lexA')
SNF2_like = c('kis','okr','Chd1','Etl1')
nucleosome_remod <- c(brm_complex, pbap_complex, bap_complex, ino80, dom, atac, NURF, ACF, NURD, SNF2_like)
dom_complex <- c('dom','Tip60','pont', 'rept','Nipped-A','Brd8')
outdata <- read.csv('../output/resultsDF.csv') %>%
dplyr::mutate(id = paste(symbol, line, sep = "_"),
nucleosome_remodeler = ifelse(symbol %in% nucleosome_remod, T, F),
Negcontrol = dplyr::case_when(symbol %in% control ~ 'Negative-Control',
T ~ 'test'),
complex_general = dplyr::case_when(symbol %in% brm_complex | symbol %in% pbap_complex | symbol %in% bap_complex ~ 'PBAP/BAP',
symbol %in% control ~ 'Negative-Control',
T ~ 'other'),
complex = dplyr::case_when(symbol %in% brm_complex ~ 'core',
symbol %in% pbap_complex ~ 'pbap',
symbol %in% bap_complex ~ 'bap',
symbol %in% control ~ 'Negative-Control',
T ~ 'other'),
other_complex = dplyr::case_when(symbol %in% brm_complex ~ '(p)bap',
symbol %in% pbap_complex ~ 'pbap',
symbol %in% bap_complex ~ 'bap',
symbol %in% control ~ 'Negative-Control',
symbol %in% ino80 ~ 'Ino80',
symbol %in% dom ~ 'Domino',
symbol %in% atac ~ 'ATAC',
symbol %in% NURF ~ 'NURF',
symbol %in% ACF ~ 'ACF',
symbol %in% NURD ~ 'NURD',
symbol %in% NORC ~ 'NORC',
symbol %in% demethyl ~ 'Demethylase',
T ~ 'other')) %>%
dplyr::filter(stack >= 10 & gfp >= 8 & size == "1024x1024") %>%
dplyr::group_by(id) %>%
dplyr::mutate(area_ratio = gfp_mask_area / gfpNEG_mask_area,
area_sum = gfp_mask_area + gfpNEG_mask_area,
log2 = log2(KDtoWT),
mean_ratio = median(KDtoWT),
meanlog2 = mean(log2), # changing from filter on mean_log2...
bap_hits = dplyr::case_when(mean_ratio >= 1.2 & complex_general == 'PBAP/BAP' ~ 'Brahma Complex', #increase of atleast 150%
complex_general == 'Negative-Control' ~ 'Negative-Control',
T ~ 'other'))
nr <- outdata %>% dplyr::filter(nucleosome_remodeler | Negcontrol == 'Negative-Control')
lines <- length(unique(outdata$line))
genes <- length(unique(outdata$symbol))
complexes <- length(unique(outdata$other_complex))
#average number of wings per line
outdata %>%
dplyr::group_by(symbol, line) %>%
dplyr::count(line) %>%
dplyr::ungroup() %>%
dplyr::summarise(mean = mean(n))
#write csv with just the tested lines for reference
write.table(unique(outdata$line), "r_out/tested-lines.csv", quote = F, col.names = F, row.names = F, sep = ',')
#unique(outdata$line)
less_than_4_wings <- outdata %>%
dplyr::group_by(symbol, line) %>%
dplyr::count(line) %>%
dplyr::arrange(n) %>%
dplyr::filter(n <= 4)
write.table(less_than_4_wings, "r_out/lines_with_less_than_4_wings.csv", row.names = F, quote = F,sep = ',')
summary_df <- data.frame('Lines' = lines,
'Genes' = genes,
'Complexes' = complexes)
summary_grob <- gridExtra::tableGrob(summary_df, rows = NULL, )
h = grid::convertHeight(sum(summary_grob$heights), "in", T)
w = grid::convertHeight(sum(summary_grob$widths), "in", T)
ggplot2::ggsave("r_out/summary_table.pdf", summary_grob, width = w, height = h)
# filter out any images with stack # <10, GFP < 8 (no GFP driver), and only use 1024x1024 dimensions
outdata %>%
dplyr::filter(stack >= 10 &
gfp >= 8 &
size == "1024x1024") %>%
dplyr::group_by(symbol, line) %>%
dplyr::mutate(med = median(KDtoWT)) %>%
ggplot(aes(KDtoWT, forcats::fct_reorder(id, KDtoWT))) +
geom_vline(xintercept = 1, color = "grey50") +
geom_boxplot(aes(fill = complex), outlier.shape = NA) +
scale_y_discrete(position = 'right') +
scale_x_continuous(trans = "log2") +
scale_fill_manual(values = color_scale) +
xlab("log2(KD/WT)") +
ylab("brDisc KD/WT") +
theme(#axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
#        legend.position = "none",
axis.text.y = element_text(size = 10),
axis.title.y = element_blank())
ggsave('r_out/kd_wt-brmComplex-plot.png', width = 7, height = 9)
nr %>%
#ggplot(aes(log2, forcats::fct_reorder(id, log2) )) +
ggplot(aes(KDtoWT, forcats::fct_reorder(id, KDtoWT) )) +
geom_vline(xintercept = 1, color = "grey50") +
geom_vline(xintercept = 1.2, color = "grey50", linetype = "longdash") + # somewhat arbitrary cutoff - based on visually confirmed hits
geom_boxplot(aes(fill = bap_hits), outlier.size = 0.5) +
scale_fill_manual(values = c("#66C2A6",'#F059A2','white')) +
scale_x_continuous(trans = "log2") + # trying out a log transformation rather than using the log2 FC data
xlab("brD KD/WT (log2 trans)") +
theme(axis.text.y = element_text(size = 10, ),
axis.title.y = element_blank(),
panel.background = element_rect(fill = 'white', colour = 'grey10'),
panel.grid.major  = element_line(color = 'grey90'),
legend.title = element_blank(),
legend.position = 'bottom')
ggsave('r_out/kd_wt-brmComplex-horizontal-plot-GENERAL.png', width = 5, height = 8)
