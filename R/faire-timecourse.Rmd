```{r setup}
library(magrittr)

source('scripts/utils.R')

load('~/McKay/FAIRE_dm6/faire_dm6.RDS') #loads closing, opening, and fairePoolSheet

load('rData/sheets.RDS')
load('rData/union-df.RData')
load('rData/osa-idr-peak-sets.RDS')
load('rData/deseq.RDS')


```


```{r faire-in-osa}
#makeSAF(osaGFP.dds %>% dplyr::filter(osa.idr.sig.3 & !yw.idr.sig.3)) %>% na.omit()
osa.idr.timecourse_faire_counts <- Rsubread::featureCounts(fairePoolSheet$bam, 
                                       annot.ext = makeSAF(osa.idr),
                                       nthreads = 4)

colnames(osa.idr.timecourse_faire_counts$counts) <- fairePoolSheet$sample


osa.idr.3.timecourse_faire_counts <- Rsubread::featureCounts(fairePoolSheet$bam, 
                                       annot.ext = makeSAF(osa.idr.3),
                                       nthreads = 4)

colnames(osa.idr.3.timecourse_faire_counts$counts) <- fairePoolSheet$sample

osa.idr.05.timecourse_faire_counts <- Rsubread::featureCounts(fairePoolSheet$bam, 
                                       annot.ext = makeSAF(osa.idr.05),
                                       nthreads = 4)

colnames(osa.idr.05.timecourse_faire_counts$counts) <- fairePoolSheet$sample
```

```{r faire-in-osa_deseq}

idr.faire_timecourse_dds <- DESeq2::DESeqDataSetFromMatrix(osa.idr.timecourse_faire_counts$counts, colData = fairePoolSheet, ~time) %>% 
  DESeq2::estimateSizeFactors(.) 

idr.3.faire_timecourse_dds <- DESeq2::DESeqDataSetFromMatrix(osa.idr.3.timecourse_faire_counts$counts, colData = fairePoolSheet, ~time) %>% 
  DESeq2::estimateSizeFactors(.)

idr.05.faire_timecourse_dds <- DESeq2::DESeqDataSetFromMatrix(osa.idr.05.timecourse_faire_counts$counts, colData = fairePoolSheet, ~time) %>% 
  DESeq2::estimateSizeFactors(.)

idr.faire_tc_counts <- DESeq2::counts(idr.faire_timecourse_dds, normalized = T) 

idr.3.faire_tc_counts <- DESeq2::counts(idr.3.faire_timecourse_dds, normalized = T) 

idr.05.faire_tc_counts <- DESeq2::counts(idr.05.faire_timecourse_dds, normalized = T) 

# Take mean(cpm) per peak over time
idr.faire_tc_mat <- idr.faire_tc_counts %>%
  data.frame %>%
  tibble::rownames_to_column("id") %>%
  reshape2::melt(id.vars = "id", variable.name = "Sample", value.name = c("cpm")) %>%
  dplyr::mutate(Sample = factor(Sample, levels = c('wt_3LW','wt_6h','wt_18h','wt_24h','wt_44h'))) %>%
  tidyr::spread(key = "Sample", value = "cpm") %>%
  data.frame %>% 
  tibble::column_to_rownames("id") %>% 
  as.matrix



idr.3.faire_tc_mat <- idr.3.faire_tc_counts %>%
  data.frame %>%
  tibble::rownames_to_column("id") %>%
  reshape2::melt(id.vars = "id", variable.name = "Sample", value.name = c("cpm")) %>%
  dplyr::mutate(Sample = factor(Sample, levels = c('wt_3LW','wt_6h','wt_18h','wt_24h','wt_44h'))) %>%
  tidyr::spread(key = "Sample", value = "cpm") %>%
  data.frame %>% 
  tibble::column_to_rownames("id") %>% 
  as.matrix



idr.05.faire_tc_mat <- idr.faire_tc_counts %>%
  data.frame %>%
  tibble::rownames_to_column("id") %>%
  reshape2::melt(id.vars = "id", variable.name = "Sample", value.name = c("cpm")) %>%
  dplyr::mutate(Sample = factor(Sample, levels = c('wt_3LW','wt_6h','wt_18h','wt_24h','wt_44h'))) %>%
  tidyr::spread(key = "Sample", value = "cpm") %>%
  data.frame %>% 
  tibble::column_to_rownames("id") %>% 
  as.matrix




```

Convert matrix to fraction of max. K-means clustering using k 2-15. Assess goodness of fit with elbow & withinss.
```{r faire-in-osa_FracMaxMatrix_and_Heatmap}

idr.fracMaxFaireMat <- idr.faire_tc_mat %>% 
  {. / MatrixGenerics::rowMaxs(.)} %>% 
  na.omit()


idr.3.fracMaxFaireMat <- idr.3.faire_tc_mat %>% 
  {. / MatrixGenerics::rowMaxs(.)} %>% 
  na.omit()

idr.05.fracMaxFaireMat <- idr.05.faire_tc_mat %>% 
  {. / MatrixGenerics::rowMaxs(.)} %>% 
  na.omit()

idr.fracMaxFaireMat_norownames <- idr.fracMaxFaireMat

idr.3.fracMaxFaireMat_norownames <- idr.3.fracMaxFaireMat

idr.05.fracMaxFaireMat_norownames <- idr.05.fracMaxFaireMat

rownames(idr.fracMaxFaireMat_norownames) <- NULL

rownames(idr.3.fracMaxFaireMat_norownames) <- NULL

rownames(idr.05.fracMaxFaireMat_norownames) <- NULL

###png('rOut/fracMax_Faire_heat.png', width = 5, height = 4, units = 'in', res = 300)
superheat::superheat(idr.fracMaxFaireMat,
                    n.clusters.rows = 8,     
                     pretty.order.rows = T)
#dev.off()

superheat::superheat(idr.3.fracMaxFaireMat,
                    n.clusters.rows = 6,     
                     pretty.order.rows = T)

superheat::superheat(idr.05.fracMaxFaireMat,
                    n.clusters.rows = 6,     
                     pretty.order.rows = T)
```

# trying out profileplyr with deepTools computeMatrix output

```{r}
proplyrobject <- profileplyr::import_deepToolsMat('deepPlots/osaIDR_FAIRE_timecourse.gz')

rownames(profileplyr::sampleData(proplyrobject)) <- c('18h', '24h', '3LW', '44h', '6h')
l3 <- proplyrobject[ , , c(3,5,1)]

kmeans <- profileplyr::clusterRanges(l3, kmeans_k = 4, silent = F)

profileplyr::generateEnrichedHeatmap(kmeans)
```

# trying to pull clusters from deepTools 3LW FAIRE + osaGFP 
```{r grp1}
osa.grp1.timecourse_faire_counts <- Rsubread::featureCounts(fairePoolSheet$bam, 
                                       annot.ext = makeSAF(osa.idr %>% dplyr::filter(deepClusters == 'grp.1')),
                                       nthreads = 4)
colnames(osa.grp1.timecourse_faire_counts$counts) <- fairePoolSheet$sample

grp1.faire_timecourse_dds <- DESeq2::DESeqDataSetFromMatrix(osa.grp1.timecourse_faire_counts$counts, colData = fairePoolSheet, ~time) %>% 
  DESeq2::estimateSizeFactors(.) 

grp1.faire_tc_counts <- DESeq2::counts(grp1.faire_timecourse_dds, normalized = T) 

grp1.faire_tc_mat <- grp1.faire_tc_counts%>% 
  data.frame %>% 
  tibble::rownames_to_column("id") %>%
  reshape2::melt(id.vars = "id", variable.name = "Sample", value.name = c("cpm"))%>% 
  dplyr::mutate(Sample = factor(Sample, levels = c('wt_3LW','wt_6h','wt_18h','wt_24h','wt_44h'))) %>%
  tidyr::spread(key = "Sample", value = "cpm") %>%
  data.frame %>% 
  tibble::column_to_rownames("id") %>% 
  as.matrix


grp1.fracMaxFaireMat <- grp1.faire_tc_mat %>% 
  {. / MatrixGenerics::rowMaxs(.)} %>% 
  na.omit()

grp1.fracMaxFaireMat_norownames <- grp1.fracMaxFaireMat

rownames(grp1.fracMaxFaireMat_norownames) <- NULL

superheat::superheat(grp1.fracMaxFaireMat,
                    n.clusters.rows = 6,     
                     pretty.order.rows = T)


```

```{r grp2}
osa.grp2.timecourse_faire_counts <- Rsubread::featureCounts(fairePoolSheet$bam, 
                                       annot.ext = makeSAF(osa.idr %>% dplyr::filter(deepClusters == 'grp.2')),
                                       nthreads = 4)
colnames(osa.grp2.timecourse_faire_counts$counts) <- fairePoolSheet$sample

grp2.faire_timecourse_dds <- DESeq2::DESeqDataSetFromMatrix(osa.grp2.timecourse_faire_counts$counts, colData = fairePoolSheet, ~time) %>% 
  DESeq2::estimateSizeFactors(.) 

grp2.faire_tc_counts <- DESeq2::counts(grp2.faire_timecourse_dds, normalized = T) 

grp2.faire_tc_mat <- grp2.faire_tc_counts%>% 
  data.frame %>% 
  tibble::rownames_to_column("id") %>%
  reshape2::melt(id.vars = "id", variable.name = "Sample", value.name = c("cpm"))%>% 
  dplyr::mutate(Sample = factor(Sample, levels = c('wt_3LW','wt_6h','wt_18h','wt_24h','wt_44h'))) %>%
  tidyr::spread(key = "Sample", value = "cpm") %>%
  data.frame %>% 
  tibble::column_to_rownames("id") %>% 
  as.matrix


grp2.fracMaxFaireMat <- grp2.faire_tc_mat %>% 
  {. / MatrixGenerics::rowMaxs(.)} %>% 
  na.omit()

grp2.fracMaxFaireMat_norownames <- grp2.fracMaxFaireMat

rownames(grp2.fracMaxFaireMat_norownames) <- NULL

superheat::superheat(grp2.fracMaxFaireMat,
                    n.clusters.rows = 6,     
                     pretty.order.rows = T)


```
```{r grp3}
osa.grp3.timecourse_faire_counts <- Rsubread::featureCounts(fairePoolSheet$bam, 
                                       annot.ext = makeSAF(osa.idr %>% dplyr::filter(deepClusters == 'grp.3')),
                                       nthreads = 4)
colnames(osa.grp3.timecourse_faire_counts$counts) <- fairePoolSheet$sample

grp3.faire_timecourse_dds <- DESeq2::DESeqDataSetFromMatrix(osa.grp3.timecourse_faire_counts$counts, colData = fairePoolSheet, ~time) %>% 
  DESeq2::estimateSizeFactors(.) 

grp3.faire_tc_counts <- DESeq2::counts(grp3.faire_timecourse_dds, normalized = T) 

grp3.faire_tc_mat <- grp3.faire_tc_counts%>% 
  data.frame %>% 
  tibble::rownames_to_column("id") %>%
  reshape2::melt(id.vars = "id", variable.name = "Sample", value.name = c("cpm"))%>% 
  dplyr::mutate(Sample = factor(Sample, levels = c('wt_3LW','wt_6h','wt_18h','wt_24h','wt_44h'))) %>%
  tidyr::spread(key = "Sample", value = "cpm") %>%
  data.frame %>% 
  tibble::column_to_rownames("id") %>% 
  as.matrix


grp3.fracMaxFaireMat <- grp3.faire_tc_mat %>% 
  {. / MatrixGenerics::rowMaxs(.)} %>% 
  na.omit()

grp3.fracMaxFaireMat_norownames <- grp3.fracMaxFaireMat

rownames(grp3.fracMaxFaireMat_norownames) <- NULL

superheat::superheat(grp3.fracMaxFaireMat,
                    n.clusters.rows = 6,     
                     pretty.order.rows = T)


```
```{r grp4}
osa.grp4.timecourse_faire_counts <- Rsubread::featureCounts(fairePoolSheet$bam, 
                                       annot.ext = makeSAF(osa.idr %>% dplyr::filter(deepClusters == 'grp.4')),
                                       nthreads = 4)
colnames(osa.grp4.timecourse_faire_counts$counts) <- fairePoolSheet$sample

grp4.faire_timecourse_dds <- DESeq2::DESeqDataSetFromMatrix(osa.grp4.timecourse_faire_counts$counts, colData = fairePoolSheet, ~time) %>% 
  DESeq2::estimateSizeFactors(.) 

grp4.faire_tc_counts <- DESeq2::counts(grp4.faire_timecourse_dds, normalized = T) 

grp4.faire_tc_mat <- grp4.faire_tc_counts%>% 
  data.frame %>% 
  tibble::rownames_to_column("id") %>%
  reshape2::melt(id.vars = "id", variable.name = "Sample", value.name = c("cpm"))%>% 
  dplyr::mutate(Sample = factor(Sample, levels = c('wt_3LW','wt_6h','wt_18h','wt_24h','wt_44h'))) %>%
  tidyr::spread(key = "Sample", value = "cpm") %>%
  data.frame %>% 
  tibble::column_to_rownames("id") %>% 
  as.matrix


grp4.fracMaxFaireMat <- grp4.faire_tc_mat %>% 
  {. / MatrixGenerics::rowMaxs(.)} %>% 
  na.omit()

grp4.fracMaxFaireMat_norownames <- grp4.fracMaxFaireMat

rownames(grp4.fracMaxFaireMat_norownames) <- NULL

superheat::superheat(grp4.fracMaxFaireMat,
                    n.clusters.rows = 6,     
                     pretty.order.rows = T)


```

```{r grp4}
osa.grp5.timecourse_faire_counts <- Rsubread::featureCounts(fairePoolSheet$bam, 
                                       annot.ext = makeSAF(osa.idr %>% dplyr::filter(deepClusters == 'grp.5')),
                                       nthreads = 4)
colnames(osa.grp5.timecourse_faire_counts$counts) <- fairePoolSheet$sample

grp5.faire_timecourse_dds <- DESeq2::DESeqDataSetFromMatrix(osa.grp5.timecourse_faire_counts$counts, colData = fairePoolSheet, ~time) %>% 
  DESeq2::estimateSizeFactors(.) 

grp5.faire_tc_counts <- DESeq2::counts(grp5.faire_timecourse_dds, normalized = T) 

grp5.faire_tc_mat <- grp5.faire_tc_counts%>% 
  data.frame %>% 
  tibble::rownames_to_column("id") %>%
  reshape2::melt(id.vars = "id", variable.name = "Sample", value.name = c("cpm"))%>% 
  dplyr::mutate(Sample = factor(Sample, levels = c('wt_3LW','wt_6h','wt_18h','wt_24h','wt_44h'))) %>%
  tidyr::spread(key = "Sample", value = "cpm") %>%
  data.frame %>% 
  tibble::column_to_rownames("id") %>% 
  as.matrix


grp5.fracMaxFaireMat <- grp5.faire_tc_mat %>% 
  {. / MatrixGenerics::rowMaxs(.)} %>% 
  na.omit()

grp5.fracMaxFaireMat_norownames <- grp5.fracMaxFaireMat

rownames(grp5.fracMaxFaireMat_norownames) <- NULL

superheat::superheat(grp5.fracMaxFaireMat,
                    n.clusters.rows = 6,     
                     pretty.order.rows = T)


```


```{r grp6}
osa.grp6.timecourse_faire_counts <- Rsubread::featureCounts(fairePoolSheet$bam, 
                                       annot.ext = makeSAF(osa.idr %>% dplyr::filter(deepClusters == 'grp.6')),
                                       nthreads = 4)
colnames(osa.grp6.timecourse_faire_counts$counts) <- fairePoolSheet$sample

grp6.faire_timecourse_dds <- DESeq2::DESeqDataSetFromMatrix(osa.grp6.timecourse_faire_counts$counts, colData = fairePoolSheet, ~time) %>% 
  DESeq2::estimateSizeFactors(.) 

grp6.faire_tc_counts <- DESeq2::counts(grp6.faire_timecourse_dds, normalized = T) 

grp6.faire_tc_mat <- grp6.faire_tc_counts%>% 
  data.frame %>% 
  tibble::rownames_to_column("id") %>%
  reshape2::melt(id.vars = "id", variable.name = "Sample", value.name = c("cpm"))%>% 
  dplyr::mutate(Sample = factor(Sample, levels = c('wt_3LW','wt_6h','wt_18h','wt_24h','wt_44h'))) %>%
  tidyr::spread(key = "Sample", value = "cpm") %>%
  data.frame %>% 
  tibble::column_to_rownames("id") %>% 
  as.matrix


grp6.fracMaxFaireMat <- grp6.faire_tc_mat %>% 
  {. / MatrixGenerics::rowMaxs(.)} %>% 
  na.omit()

grp6.fracMaxFaireMat_norownames <- grp6.fracMaxFaireMat

rownames(grp6.fracMaxFaireMat_norownames) <- NULL

superheat::superheat(grp6.fracMaxFaireMat,
                    n.clusters.rows = 6,     
                     pretty.order.rows = T)


```


#######################

#Not using this currently... adpated from SLN
#clustering and ploting with ComplexHeatmap
```{r}
k_list <- purrr::map(2:15, ~{k <- .
  set.seed(12341)
  #set.seed(100)
  kmeans(fracMaxFaireMat, centers = k)
}) %>% 
  set_names(2:15)

k_list %>% 
  purrr::map(., "withinss") %>% 
  purrr::map_dbl(., max) %>% 
  plot(2:15, ., ylab = "max withinss", xlab = "k", main = "max withinss")

k_list %>% 
  purrr::map(., "withinss") %>% 
  purrr::map_dbl(., sum) %>% 
  plot(2:15, ., ylab = "sum withinss", xlab = "k", main = "sum withinss")
```
Plot all heatmaps at each K to assess clustering.
```{r, fig.height=10, fig.width=10, eval=F}
purrr::map(k_list[2:8], ~{ComplexHeatmap::Heatmap(fracMaxFaireMat_norownames, split = .$cluster, row_title_rot = 0, cluster_columns = F)})
```


```{r, fig.height=10, fig.width=10}
ComplexHeatmap::Heatmap(fracMaxFaireMat_norownames, split = k_list$`6`$cluster, row_title_rot = 0, cluster_columns = F)
```

```{r, fig.height=4.5, fig.width=7.5}
set.seed(1230412)
k8_redo <- kmeans(fracMaxFaireMat, 8, nstart = 25, iter.max = 15)
ComplexHeatmap::Heatmap(fracMaxFaireMat_norownames, split = k8_redo$cluster, 
        cluster_columns = F, 
        row_title_rot = 0, show_row_dend = F)
```

Reordering clusters so it looks pretty
```{r}
k_df <- k8_redo$cluster %>% 
  data.frame %>% 
  dplyr::rename(k = ".") %>% 
  tibble::rownames_to_column("id") 
  #dplyr::mutate(new_k1 = dplyr::case_when(k == 1 ~ 6,
  #                                        k == 2 ~ 2,
  #                                        k == 3 ~ 2,
  #                                        k == 4 ~ 4,
  #                                        k == 5 ~ 5,
  #                                        k == 6 ~ 1,
  #                                        k == 7 ~ 7,
  #                                        k == 8 ~ 8)) %>%
#  dplyr::rename(old_k = k, k = new_k1)

```


```{r, fig.height=10, fig.width=10}
# increase spacing between clusters on heatmap
# change colors to be colorblind friendly
# rename legend
# set legend to continuous values
# relative time names for columns?
# hide dendrogram?
#times_hours_lookup <- c("-6h" = "3LW", "6h" = "6APF", "18h" = "18APF", "24h" = "24APF", "36h" = "36APF", "44h" = "44APF")
figure_col_fun <- circlize::colorRamp2(breaks = c(0,0.5,1),
                                       colors = viridis::viridis(3))
heatmap_figure_matrix <- fracMaxFaireMat_norownames
#colnames(heatmap_figure_matrix) <- names(times_hours_lookup)
```


```{r, fig.height=4.5, fig.width=7.5}
figure_kmeans_heatmap <- ComplexHeatmap::Heatmap(heatmap_figure_matrix, 
                        split = k_df$k, 
                        cluster_columns = F, 
                        row_title_rot = 0, 
                        heatmap_legend_param = list(color_bar = "continuous", 
                                                    at = c(0, 0.5, 1),
                                                    title = "Fraction of Max\nFAIRE Signal",
                                                    title_position = "topcenter",
                                                    grid_height = unit(1.5, "lines")), 
                        # Appears column title rotation is broken in this release...
                        column_title_rot = 0, 
                        show_row_dend = F,
                        gap = unit(0.5, "lines"),
                        col = figure_col_fun) 
figure_kmeans_heatmap
```